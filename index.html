<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GanttMaster</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            750: '#293548',
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    cursor: {
                        'col-resize': 'col-resize',
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 12px; height: 12px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 6px; 
            border: 2px solid #f1f5f9; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #475569; 
            border-color: #1e293b;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Hide Date Picker Icon */
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        
        /* Animation */
        @keyframes fade-in { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        
        /* Tooltip */
        .tooltip-box {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .min-row-height { min-height: 52px; }
        .header-height { height: 70px; }
        
        /* Hover Add Trigger */
        .hover-add-trigger {
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none; 
        }
        td:hover .hover-add-trigger, .hover-add-trigger:hover {
            opacity: 1;
            pointer-events: auto;
        }

        /* Textarea Auto-height styling */
        .auto-textarea {
            resize: none;
            overflow: hidden;
            min-height: 24px; 
            height: auto;
            display: block;
            line-height: 1.25rem;
            padding-top: 0.1rem;
        }

        /* Resizer Handle */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: #e2e8f0;
            transition: background-color 0.2s;
            z-index: 50;
            flex-shrink: 0;
        }
        .dark .resizer { background-color: #334155; }
        .resizer:hover, .resizer.resizing {
            background-color: #3b82f6;
        }

        /* Parent Row Styling */
        .parent-row input, .parent-row textarea, .parent-row select {
            font-weight: 700;
            color: #1e293b;
        }
        .dark .parent-row input, .dark .parent-row textarea, .dark .parent-row select {
            color: #e2e8f0;
        }
        .parent-row {
            background-color: #f8fafc;
        }
        .dark .parent-row {
            background-color: #1e293b;
        }
    </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 h-screen flex flex-col overflow-hidden transition-colors duration-200">

    <!-- Navbar -->
    <nav class="border-b border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-3 flex items-center justify-between sticky top-0 z-40 shadow-sm shrink-0 transition-colors duration-200">
        <div class="flex items-center gap-3 min-w-0 flex-1">
            <div class="bg-blue-600 p-2 rounded-lg text-white shadow-blue-200 dark:shadow-none shadow-lg shrink-0">
                <i data-lucide="align-left" class="w-5 h-5"></i>
            </div>
            <div class="flex flex-col min-w-0 flex-1 mr-4">
                <input id="app-title" type="text" class="font-bold text-lg leading-tight tracking-tight outline-none bg-transparent hover:bg-gray-50 dark:hover:bg-slate-700 focus:bg-gray-50 dark:focus:bg-slate-700 rounded px-1 transition-colors w-full truncate text-slate-800 dark:text-slate-100" value="Project Timeline">
                <div class="flex items-center gap-2 text-[10px] text-gray-400 w-full">
                    <input id="app-subtitle" type="text" class="uppercase tracking-widest font-medium outline-none bg-transparent hover:bg-gray-50 dark:hover:bg-slate-700 focus:bg-gray-50 dark:focus:bg-slate-700 rounded px-1 transition-colors w-full max-w-[250px]" value="GANTTMASTER">
                    <span class="w-px h-3 bg-gray-300 dark:bg-slate-600 shrink-0"></span>
                    <span id="save-status" class="truncate min-w-0 shrink-0 text-gray-400">Unsaved</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4 shrink-0">
            <!-- Zoom Controls -->
            <div class="hidden md:flex items-center bg-gray-100 dark:bg-slate-700 rounded-lg p-1">
                <button onclick="app.zoomOut()" class="p-1.5 text-gray-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-white dark:hover:bg-slate-600 rounded transition-colors" title="Zoom Out"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                <input id="zoom-input" type="text" class="bg-transparent text-xs font-bold text-gray-600 dark:text-slate-200 outline-none mx-1 w-10 text-center focus:bg-white dark:focus:bg-slate-600 rounded" value="100%">
                <button onclick="app.zoomIn()" class="p-1.5 text-gray-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-white dark:hover:bg-slate-600 rounded transition-colors" title="Zoom In"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
            </div>
            
            <button onclick="app.toggleDarkMode()" class="p-2 text-gray-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors" title="Toggle Dark Mode">
                <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
            </button>
            
            <div class="flex items-center gap-2">
                <button onclick="app.saveChart()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-slate-200 rounded-lg text-sm font-medium transition-colors"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Save</span></button>
                <button onclick="app.shareLink()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md shadow-blue-200 transition-colors"><i data-lucide="share-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Share</span></button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden relative" id="main-container">
        
        <!-- Table Pane -->
        <div id="table-pane" class="overflow-y-auto overflow-x-auto border-r border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 h-full custom-scrollbar flex-none z-10 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.05)]" style="width: 700px; flex-shrink: 0;">
            <table class="w-full text-sm text-left table-fixed min-w-[700px]">
                <thead class="text-xs text-gray-700 dark:text-slate-400 uppercase bg-gray-50 dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 sticky top-0 z-20 header-height shadow-sm">
                    <tr>
                        <th class="px-2 align-middle w-14 text-center border-r border-gray-100 dark:border-slate-700">#</th>
                        <th class="px-2 align-middle w-40 border-r border-gray-100 dark:border-slate-700">Activity</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">Start</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">End</th>
                        <th class="px-2 align-middle w-12 text-center border-r border-gray-100 dark:border-slate-700">Days</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">PIC</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">Status</th>
                        <th class="px-2 align-middle w-10"></th>
                    </tr>
                </thead>
                <tbody id="task-table-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
            <!-- Bottom Spacer -->
            <div class="h-24 w-full bg-transparent"></div>
        </div>

        <!-- Resizer -->
        <div id="pane-resizer" class="resizer"></div>

        <!-- Chart Pane -->
        <div id="chart-pane" class="flex-1 overflow-auto bg-gray-50/50 dark:bg-slate-900 relative custom-scrollbar h-full cursor-grab">
            <div id="chart-content" class="relative pb-20">
                <!-- Header Dates -->
                <div id="chart-header" class="flex border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 sticky top-0 z-10 header-height shadow-sm">
                    <!-- Dates generated by JS -->
                </div>
                <!-- Bars -->
                <div id="chart-bars" class="pt-0">
                    <!-- Bars generated by JS -->
                </div>
                <!-- Today Line -->
                <div id="today-line" class="absolute top-0 bottom-0 border-l-2 border-red-500/40 z-0 pointer-events-none hidden">
                    <div class="bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow-sm absolute -top-1 -left-5 z-20 font-bold tracking-wide">TODAY</div>
                </div>
                <!-- Bottom Spacer -->
                <div class="h-24 w-full bg-transparent"></div>
            </div>
        </div>

    </div>

    <!-- Drawer: Legend & Config -->
    <div id="drawer-container" class="fixed bottom-0 left-0 right-0 z-[60] flex flex-col justify-end transition-transform duration-300 translate-y-full pointer-events-none">
         
         <!-- Tab Button (Sticks out) -->
         <div class="w-full flex justify-end px-6 pb-0 absolute -top-10 right-0 pointer-events-auto">
            <button onclick="app.toggleLegend()" class="bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 border-t border-l border-r border-gray-200 dark:border-slate-700 px-5 py-2.5 rounded-t-xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex items-center gap-2 text-sm font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition-all">
                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                <span>Legend & Config</span>
                <span id="legend-chevron" class="ml-1 transition-transform duration-300"><i data-lucide="chevron-up" class="w-4 h-4"></i></span>
            </button>
         </div>

         <!-- Config Panel Content -->
         <div id="legend-panel" class="pointer-events-auto bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 shadow-2xl max-h-[50vh] overflow-y-auto custom-scrollbar w-full">
            <div class="p-8 max-w-7xl mx-auto">
                <div id="legend-content" class="grid grid-cols-1 md:grid-cols-3 gap-12">
                    <!-- Content Injected via JS -->
                </div>
            </div>
         </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <!-- Custom Tooltip (Updated Visuals) -->
    <div id="custom-tooltip" class="hidden fixed z-[100] bg-gray-900/90 backdrop-blur-sm text-white px-3 py-2 rounded-lg shadow-xl text-xs pointer-events-none mt-[-8px] tooltip-box">
        <div id="tooltip-title" class="font-bold mb-1 border-b border-gray-700 pb-1"></div>
        <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1 text-[10px] text-gray-300">
            <span>Status:</span> <span id="tooltip-status" class="text-white font-medium"></span>
            <span>Period:</span> <span id="tooltip-date" class="text-white font-mono"></span>
        </div>
        <!-- Arrow removed -->
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // =================================================================================
        // CONFIGURATION: REPLACE THIS SECTION WITH YOUR FIREBASE KEYS FOR GITHUB HOSTING
        // =================================================================================
        
        let firebaseConfig = {
            apiKey: "AIzaSyBaZJ49zEo4GoWR3LoyDba5J3wkPkaOfWs",
            authDomain: "gantt-master.firebaseapp.com",
            projectId: "gantt-master",
            storageBucket: "gantt-master.firebasestorage.app",
            messagingSenderId: "822947741694",
            appId: "1:822947741694:web:41f0828656259cc0200aaf",
            measurementId: "G-2KK6BNYHPP"
        };

        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gantt-master-public';
        // =================================================================================

        let appInstance, authInstance, dbInstance;
        
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
                appInstance = initializeApp(firebaseConfig);
                authInstance = getAuth(appInstance);
                dbInstance = getFirestore(appInstance);
            } else {
                console.warn("Firebase not configured.");
            }
        } catch(e) {
            console.error("Firebase Init Error:", e);
        }

        const state = {
            user: null,
            chartId: null,
            loading: true,
            zoom: 40,
            showLegend: false,
            activeDropdown: null,
            saveTimer: null,
            darkMode: false,
            scrollPos: { table: 0, chart: 0 },
            config: {
                title: "Project Timeline",
                subtitle: "GANTTMASTER",
                themeColor: '#3b82f6', // Default Blue Base Color
                paneWidth: 700, // Default width
                picMap: [
                    { id: '1', abbr: 'TL', name: 'Team Lead', color: '#3b82f6' },
                    { id: '2', abbr: 'DEV', name: 'Developer', color: '#8b5cf6' },
                    { id: '3', abbr: 'DES', name: 'Designer', color: '#ec4899' },
                    { id: '4', abbr: 'QA', name: 'QA Engineer', color: '#f97316' },
                ],
                statusMap: [
                    { id: '1', name: 'Completed', color: '#22c55e' },
                    { id: '2', name: 'In Progress', color: '#eab308' },
                    { id: '3', name: 'Pending', color: '#94a3b8' },
                    { id: '4', name: 'Delayed', color: '#ef4444' },
                ]
            },
            tasks: [
                { id: '1', activityNo: '1.0', description: 'Project Phase', startDate: new Date().toISOString().split('T')[0], duration: 10, pics: ['TL'], status: 'In Progress' },
                { id: '2', activityNo: '1.1', description: 'Major Activity', startDate: new Date().toISOString().split('T')[0], duration: 5, pics: ['DEV'], status: 'Completed' },
            ]
        };

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        // Display Format - DD/MM/YY
        function formatDateDisplay(isoStr) { 
            if(!isoStr) return ''; 
            if(isoStr.includes('/')) return isoStr; 
            const [y, m, d] = isoStr.split('-');
            return `${d}/${m}/${y.slice(2)}`;
        }
        function addDays(str, days) { 
            if(!str) return '';
            const d = new Date(str); 
            if(isNaN(d.getTime())) return '';
            d.setDate(d.getDate() + parseInt(days)); 
            return d.toISOString().split('T')[0]; 
        }
        function getDaysDiff(start, end) { return Math.round((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)); }
        
        function getTaskLevel(activityNo) {
            if(!activityNo) return 0;
            return (activityNo.match(/\./g) || []).length; 
        }
        
        function adjustBrightness(col, amt) {
            var usePound = false;
            if (col[0] == "#") {
                col = col.slice(1);
                usePound = true;
            }
            var num = parseInt(col,16);
            var r = (num >> 16) + amt;
            if (r > 255) r = 255; else if  (r < 0) r = 0;
            var b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255; else if  (b < 0) b = 0;
            var g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255; else if  (g < 0) g = 0;
            return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16).padStart(6,'0');
        }
        
        function getContrastYIQ(hexcolor){
            if(!hexcolor) return 'black';
            if(hexcolor.startsWith('#')) hexcolor = hexcolor.substring(1);
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function getThemeColor(baseColor, level) {
            const step = 30; // Brightness step
            const maxLevel = 4;
            const cappedLevel = Math.min(level, maxLevel);
            return adjustBrightness(baseColor, cappedLevel * step);
        }

        const App = {
            init: async () => {
                if (authInstance) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInstance, __initial_auth_token);
                    else await signInAnonymously(authInstance);
                    onAuthStateChanged(authInstance, (u) => { state.user = u; App.loadData(); });
                } else {
                    App.renderAll();
                }

                if (localStorage.getItem('gantt-theme') === 'dark' || (!('gantt-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    state.darkMode = true;
                    document.getElementById('theme-icon').setAttribute('data-lucide', 'sun');
                }

                const resizer = document.getElementById('pane-resizer');
                const tablePane = document.getElementById('table-pane');
                
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    document.body.style.cursor = 'col-resize';
                    resizer.classList.add('resizing');
                    
                    const moveHandler = (moveEvent) => {
                        const newWidth = moveEvent.clientX;
                        if (newWidth > 300 && newWidth < window.innerWidth - 100) {
                            tablePane.style.width = `${newWidth}px`;
                        }
                    };

                    const upHandler = (upEvent) => {
                        document.body.style.cursor = '';
                        resizer.classList.remove('resizing');
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('mouseup', upHandler);
                        
                        const finalWidth = tablePane.getBoundingClientRect().width;
                        state.config.paneWidth = finalWidth;
                        App.autoSave();
                    };

                    document.addEventListener('mousemove', moveHandler);
                    document.addEventListener('mouseup', upHandler);
                });


                const tp = document.getElementById('table-pane'), cp = document.getElementById('chart-pane');
                let syncL = false, syncR = false;
                tp.onscroll = function() { 
                    if (!syncL) { syncR = true; cp.scrollTop = this.scrollTop; } syncL = false; 
                    state.scrollPos.table = this.scrollTop;
                };
                cp.onscroll = function() { 
                    if (!syncR) { syncL = true; tp.scrollTop = this.scrollTop; } syncR = false; 
                    state.scrollPos.chart = this.scrollTop;
                };

                document.getElementById('app-title').oninput = (e) => { 
                    state.config.title = e.target.value; 
                    document.title = e.target.value + " | GanttMaster";
                    App.autoSave(); 
                };
                document.getElementById('app-subtitle').oninput = (e) => { 
                    state.config.subtitle = e.target.value; 
                    App.autoSave(); 
                };
                
                const zoomInp = document.getElementById('zoom-input');
                zoomInp.onblur = App.handleZoomSubmit;
                zoomInp.onkeydown = (e) => { if(e.key === 'Enter') App.handleZoomSubmit(); };

                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('active-dropdown');
                    if (dropdown && !dropdown.contains(e.target) && !e.target.closest('.pic-dropdown-container')) {
                        dropdown.remove();
                        state.activeDropdown = null;
                    }
                    const drawer = document.getElementById('drawer-container');
                    const tabBtn = document.querySelector('button[onclick="app.toggleLegend()"]');
                    if (state.showLegend && !drawer.contains(e.target) && !tabBtn.contains(e.target)) {
                         // Optional: Close drawer logic here if desired
                    }
                });
            },

            toggleDarkMode: () => {
                state.darkMode = !state.darkMode;
                const icon = document.getElementById('theme-icon');
                if (state.darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('gantt-theme', 'dark');
                    icon.setAttribute('data-lucide', 'sun');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('gantt-theme', 'light');
                    icon.setAttribute('data-lucide', 'moon');
                }
                App.renderConfigPanel();
                App.renderTable(); 
                lucide.createIcons();
            },

            loadData: () => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                
                if (id && dbInstance) {
                    state.chartId = id;
                    const docRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', id);
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if(data.config) state.config = { ...state.config, ...data.config };
                            if(!state.config.themeColor) state.config.themeColor = '#3b82f6';
                            if(data.tasks) state.tasks = data.tasks.map(t => ({...t, pics: Array.isArray(t.pics) ? t.pics : []}));
                            if (state.config.paneWidth) {
                                document.getElementById('table-pane').style.width = `${state.config.paneWidth}px`;
                                const tables = document.querySelectorAll('table');
                                tables.forEach(t => t.style.minWidth = `${state.config.paneWidth}px`);
                            }
                            App.identifyParents();
                            App.updateDOMFromState(data.lastUpdated, data.authorId);
                        } else {
                            App.showToast("Chart not found. Starting fresh.", "error");
                            window.history.pushState({}, '', window.location.pathname);
                            state.chartId = null;
                            App.renderAll();
                        }
                    });
                } else {
                    App.renderAll();
                }
            },

            identifyParents: () => {
                state.tasks.forEach(t => t.isParent = false);
                state.tasks.forEach(parent => {
                    const children = state.tasks.filter(child => 
                        child.id !== parent.id && 
                        child.activityNo.startsWith(parent.activityNo + '.')
                    );
                    if(children.length > 0) {
                        parent.isParent = true;
                    }
                });
            },

            updateDOMFromState: (lastUpdated, authorId) => {
                document.title = state.config.title + " | GanttMaster";
                const titleEl = document.getElementById('app-title');
                if(titleEl && document.activeElement !== titleEl) titleEl.value = state.config.title;
                const subEl = document.getElementById('app-subtitle');
                if(subEl && document.activeElement !== subEl) subEl.value = state.config.subtitle;

                if(lastUpdated) {
                    const d = new Date(lastUpdated);
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('save-status').innerText = `Last Saved: ${dateStr}`;
                }

                const tbody = document.getElementById('task-table-body');
                const existingRows = tbody.querySelectorAll('tr.group');
                if (existingRows.length !== state.tasks.length) {
                    App.renderTable();
                } else {
                    const phaseTextColor = getContrastYIQ(state.config.themeColor);
                    
                    state.tasks.forEach((task, index) => {
                        const tr = document.getElementById(`tr-${task.id}`);
                        const isPhase = !task.activityNo.includes('.');
                        const isMajor = task.activityNo.includes('.') && task.activityNo.split('.').length === 2;
                        
                        if(tr) {
                            if(isPhase) {
                                tr.style.backgroundColor = state.config.themeColor;
                                tr.style.color = phaseTextColor; 
                                tr.style.borderTop = "1px solid #cbd5e1";
                                const inputs = tr.querySelectorAll('input, textarea, select');
                                inputs.forEach(inp => {
                                    inp.style.color = phaseTextColor;
                                    inp.style.fontWeight = 'bold';
                                    if(inp.tagName === 'SELECT') {
                                        inp.style.borderColor = (phaseTextColor === 'white') ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.2)';
                                    }
                                });
                            } else if (isMajor) {
                                tr.style.backgroundColor = '';
                                tr.style.color = '';
                                tr.style.borderTop = '';
                                const inputs = tr.querySelectorAll('input, textarea, select');
                                inputs.forEach(inp => {
                                    inp.style.color = '';
                                    inp.style.fontWeight = 'bold';
                                });
                            } else {
                                tr.style.backgroundColor = '';
                                tr.style.color = '';
                                tr.style.borderTop = '';
                                const inputs = tr.querySelectorAll('input, textarea, select');
                                inputs.forEach(inp => {
                                    inp.style.color = '';
                                    inp.style.fontWeight = 'normal';
                                });
                            }
                            if(task.isParent && !tr.classList.contains('parent-row')) tr.classList.add('parent-row');
                            else if(!task.isParent && tr.classList.contains('parent-row')) tr.classList.remove('parent-row');
                        }

                        const setVal = (id, val) => {
                            const el = document.getElementById(id);
                            if(el && el.value != val && document.activeElement !== el) el.value = val;
                        };
                        setVal(`act-${task.id}`, task.activityNo);
                        
                        const descEl = document.getElementById(`desc-${task.id}`);
                        if(descEl && descEl.value !== task.description && document.activeElement !== descEl) {
                            descEl.value = task.description;
                            descEl.style.height = 'auto';
                            descEl.style.height = descEl.scrollHeight + 'px';
                        }

                        const startEl = document.getElementById(`start-${task.id}`);
                        const endEl = document.getElementById(`end-${task.id}`);
                        
                        if(startEl && document.activeElement !== startEl) {
                             if(startEl.type === 'text') startEl.value = task.startDate ? formatDateDisplay(task.startDate) : '';
                             else startEl.value = task.startDate;
                        }

                        const endDateVal = (task.startDate && task.duration) ? addDays(task.startDate, task.duration - 1) : '';
                        if(endEl && document.activeElement !== endEl) {
                            if(endEl.type === 'text') endEl.value = endDateVal ? formatDateDisplay(endDateVal) : '';
                            else endEl.value = endDateVal;
                        }

                        setVal(`dur-${task.id}`, task.duration);
                        
                        const statusSelect = document.querySelector(`#task-table-body tr:nth-child(${index+1}) select`);
                        if(statusSelect) {
                            if (statusSelect.value !== task.status && document.activeElement !== statusSelect) statusSelect.value = task.status;
                            const sConf = state.config.statusMap.find(s => s.name === task.status) || { color: '#000000' };
                            statusSelect.style.backgroundColor = `${sConf.color}20`;
                            statusSelect.style.color = sConf.color;
                            statusSelect.style.borderColor = `${sConf.color}40`;
                        }
                        
                        const picContainer = document.getElementById(`pic-container-${task.id}`);
                        if(picContainer && state.activeDropdown !== task.id) {
                            const trigger = picContainer.querySelector('.flex');
                            App.updatePicDisplay(trigger, task, isPhase);
                        }
                    });
                }
                App.renderChart();
                App.renderConfigPanel();
            },

            renderAll: () => {
                App.identifyParents();
                App.renderTable();
                App.renderChart();
                App.renderConfigPanel();
                lucide.createIcons();
            },

            renderTable: () => {
                const tbody = document.getElementById('task-table-body');
                const scrollT = document.getElementById('table-pane').scrollTop;
                tbody.innerHTML = '';
                
                const phaseTextColor = getContrastYIQ(state.config.themeColor);

                state.tasks.forEach((task, index) => {
                    const tr = document.createElement('tr');
                    tr.id = `tr-${task.id}`; 
                    
                    const isPhase = !task.activityNo.includes('.');
                    const isMajor = task.activityNo.includes('.') && task.activityNo.split('.').length === 2;
                    
                    let rowClass = "border-b border-gray-100 dark:border-slate-700 group transition-colors min-row-height";
                    let rowStyle = "";
                    let textClass = "text-gray-500 dark:text-slate-400"; 
                    
                    if (isPhase) {
                        rowStyle = `background-color: ${state.config.themeColor}; color: ${phaseTextColor}; border-top: 1px solid #cbd5e1;`;
                        textClass = `${phaseTextColor === 'white' ? 'text-white' : 'text-black'} font-bold`;
                    } else if (isMajor) {
                        rowClass += " bg-gray-50 dark:bg-slate-800";
                        textClass = "text-gray-800 dark:text-slate-200 font-bold";
                    } else {
                        rowClass += " hover:bg-gray-50 dark:hover:bg-slate-800";
                    }

                    tr.className = rowClass;
                    tr.style.cssText = rowStyle;
                    
                    const endDateVal = (task.startDate && task.duration) ? addDays(task.startDate, task.duration - 1) : '';
                    const inputClassBase = "w-full bg-transparent outline-none text-center text-xs";
                    const inputClass = isPhase ? `${inputClassBase} ${textClass} placeholder-${phaseTextColor}/70` : `${inputClassBase} ${textClass}`;
                    const descClass = isPhase ? `w-full bg-transparent outline-none text-sm auto-textarea align-middle resize-none overflow-hidden ${textClass}` : `w-full bg-transparent outline-none font-medium text-sm auto-textarea align-middle resize-none overflow-hidden ${textClass}`;
                    
                    const isLast = index === state.tasks.length - 1;
                    const hoverBtn = isLast ? '' : `
                        <button onclick="app.insertTask(${index})" class="hover-add-trigger absolute bottom-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-slate-700 border border-blue-200 dark:border-slate-600 text-blue-500 dark:text-blue-400 rounded-full w-5 h-5 flex items-center justify-center shadow-sm z-20 hover:bg-blue-50 dark:hover:bg-slate-600 hover:scale-110 cursor-pointer" title="Add activity below">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                        </button>`;
                    
                    const delBtnClass = isPhase ? `transition-colors p-1 rounded-full opacity-0 group-hover:opacity-100 text-${phaseTextColor}/70 hover:text-${phaseTextColor} hover:bg-${phaseTextColor}/20` : 'text-gray-300 dark:text-slate-600 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-50 dark:hover:bg-slate-700';

                    // Get Status Style
                    const sConf = state.config.statusMap.find(s => s.name === task.status) || { color: '#000000' };
                    const statusStyle = `background-color: ${sConf.color}20; color: ${sConf.color}; border: 1px solid ${sConf.color}40;`;

                    tr.innerHTML = `
                        <td class="px-2 align-middle text-center relative group/cell border-r border-gray-100 dark:border-slate-700">
                            <input id="act-${task.id}" type="text" class="${inputClass}" value="${task.activityNo}" oninput="app.handleInput('${task.id}', 'activityNo', this.value, this)" onchange="app.commitActivityNo('${task.id}', this.value)">
                            ${hoverBtn}
                        </td>
                        <td class="px-2 align-middle py-1 border-r border-gray-100 dark:border-slate-700">
                            <textarea id="desc-${task.id}" rows="1" class="${descClass}" oninput="app.handleInput('${task.id}', 'description', this.value, this)">${task.description}</textarea>
                        </td>
                        <td class="px-2 align-middle border-r border-gray-100 dark:border-slate-700">
                            <input id="start-${task.id}" type="text" class="${inputClass.replace('text-center','')}" 
                                value="${task.startDate ? formatDateDisplay(task.startDate) : ''}" 
                                onfocus="(this.type='date');this.showPicker();this.value='${task.startDate || ''}'" 
                                onblur="(this.type='text');this.value=app.formatDateDisplay(this.value);"
                                onchange="app.handleInput('${task.id}', 'startDate', this.value)">
                        </td>
                        <td class="px-2 align-middle border-r border-gray-100 dark:border-slate-700">
                             <input id="end-${task.id}" type="text" class="${inputClass.replace('text-center','')}" 
                                value="${endDateVal ? formatDateDisplay(endDateVal) : ''}" 
                                onfocus="(this.type='date');this.showPicker();this.value='${endDateVal || ''}'" 
                                onblur="(this.type='text');this.value=app.formatDateDisplay(this.value);"
                                onchange="app.handleInput('${task.id}', 'endDate', this.value)">
                        </td>
                        <td class="px-2 align-middle text-center border-r border-gray-100 dark:border-slate-700">
                            <input id="dur-${task.id}" type="number" min="1" class="${inputClass}" value="${task.duration}" oninput="app.handleInput('${task.id}', 'duration', this.value, this)">
                        </td>
                        <td class="px-2 align-middle pic-cell relative border-r border-gray-100 dark:border-slate-700"></td>
                        <td class="px-2 align-middle border-r border-gray-100 dark:border-slate-700">
                             <select class="bg-transparent outline-none w-full text-xs px-1 py-1 rounded cursor-pointer font-bold" style="${statusStyle}" onchange="app.handleInput('${task.id}', 'status', this.value, this)">
                                ${state.config.statusMap.map(s => `<option class="text-gray-800" value="${s.name}" ${task.status === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                             </select>
                        </td>
                        <td class="px-2 align-middle text-center">
                             <button onclick="app.removeTask('${task.id}')" class="${delBtnClass}" title="Delete Activity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    const picCell = tr.querySelector('.pic-cell');
                    picCell.appendChild(App.renderPicTrigger(task, isPhase));
                    tbody.appendChild(tr);
                    
                    setTimeout(() => {
                        const ta = document.getElementById(`desc-${task.id}`);
                        if(ta) {
                            ta.style.height = 'auto';
                            ta.style.height = ta.scrollHeight + 'px';
                        }
                    }, 0);
                });
                
                const addRow = document.createElement('tr');
                addRow.className = "row-height";
                addRow.innerHTML = `<td colspan="8" class="px-2 py-2 align-middle"><button onclick="app.addTask()" class="flex items-center gap-2 text-blue-600 dark:text-blue-400 text-sm font-medium hover:bg-blue-50 dark:hover:bg-slate-700 px-3 py-2 rounded-lg w-full transition-colors border border-dashed border-blue-200 dark:border-slate-600"><i data-lucide="plus" class="w-4 h-4"></i> Add Activity</button></td>`;
                tbody.appendChild(addRow);

                lucide.createIcons();
                document.getElementById('table-pane').scrollTop = scrollT;
                setTimeout(App.renderChart, 50);
            },

            formatDateDisplay: formatDateDisplay,
            
            commitActivityNo: (id, value) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;
                task.activityNo = value;
                App.renderTable(); 
                App.autoSave();
            },

            handleInput: (id, field, value, element) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;

                if (field === 'description' && element) {
                    element.style.height = 'auto';
                    element.style.height = element.scrollHeight + 'px';
                    task.description = value;
                } else if (field === 'duration') {
                    const dur = parseInt(value) || 1;
                    task.duration = dur;
                    const endInput = document.getElementById(`end-${id}`);
                    if(endInput && document.activeElement !== endInput) endInput.value = formatDateDisplay(addDays(task.startDate, dur - 1));
                } else if (field === 'startDate') {
                    task.startDate = value;
                    const endInput = document.getElementById(`end-${id}`);
                    if(endInput && document.activeElement !== endInput) endInput.value = formatDateDisplay(addDays(value, task.duration - 1));
                } else if (field === 'endDate') {
                    const diff = getDaysDiff(task.startDate, value);
                    const newDur = diff >= 0 ? diff + 1 : 1;
                    task.duration = newDur;
                    const durInput = document.getElementById(`dur-${id}`);
                    if(durInput) durInput.value = newDur;
                } else if (field === 'activityNo') {
                    task.activityNo = value;
                } else if (field === 'status') {
                   task.status = value;
                   // Update visual style immediately
                   const sConf = state.config.statusMap.find(s => s.name === value);
                   if (sConf && element) {
                       element.style.backgroundColor = `${sConf.color}20`;
                       element.style.color = sConf.color;
                       element.style.borderColor = `${sConf.color}40`;
                   }
                } else {
                    task[field] = value;
                }

                App.renderChart();
                App.autoSave();
            },

            addTask: () => {
                const last = state.tasks[state.tasks.length-1];
                const startDate = last ? last.startDate : '';
                const newTask = {
                    id: generateId(),
                    activityNo: ((parseFloat(last?.activityNo) || 0) + 1).toFixed(1),
                    description: 'New Activity',
                    startDate: startDate,
                    duration: 1,
                    pics: [],
                    status: 'Pending'
                };
                
                // Capture scroll before render
                const scrollT = document.getElementById('table-pane').scrollTop;
                
                state.tasks.push(newTask);
                App.renderTable();
                App.renderChart();
                
                // Scroll to bottom
                const tp = document.getElementById('table-pane');
                tp.scrollTop = tp.scrollHeight;
                
                setTimeout(() => {
                    const descInput = document.getElementById(`desc-${newTask.id}`);
                    if(descInput) descInput.focus();
                }, 0);

                App.autoSave();
            },

            renderPicTrigger: (task, isPhase) => {
                const div = document.createElement('div');
                div.className = "pic-dropdown-container w-full h-full flex items-center";
                div.id = `pic-container-${task.id}`;
                
                const trigger = document.createElement('div');
                trigger.className = "flex flex-wrap gap-1 cursor-pointer min-h-[24px] items-center w-full";
                trigger.onclick = (e) => App.openPicDropdown(e, task.id);
                
                App.updatePicDisplay(trigger, task, isPhase);
                div.appendChild(trigger);
                return div;
            },

            updatePicDisplay: (el, task, isPhase) => {
                el.innerHTML = '';
                if (!task.pics || task.pics.length === 0) {
                    el.innerHTML = `<span class="${isPhase ? 'text-white/60' : 'text-gray-300 dark:text-slate-500'} italic text-[10px]">Select</span>`;
                } else {
                    task.pics.forEach(abbr => {
                        if (abbr === 'ALL') {
                            const tag = document.createElement('span');
                            tag.className = "text-[10px] font-bold px-1 rounded shadow-sm border bg-slate-200 border-slate-300 text-black dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200";
                            tag.innerText = 'ALL';
                            el.appendChild(tag);
                        } else {
                            const conf = state.config.picMap.find(p => p.abbr === abbr) || { color: '#000' };
                            const tag = document.createElement('span');
                            tag.className = "text-[10px] font-bold px-1 rounded shadow-sm border";
                            tag.style.color = conf.color;
                            tag.style.backgroundColor = isPhase ? 'rgba(255,255,255,0.9)' : `${conf.color}20`; 
                            tag.style.borderColor = isPhase ? 'transparent' : `${conf.color}40`;
                            tag.innerText = abbr;
                            el.appendChild(tag);
                        }
                    });
                }
            },

            openPicDropdown: (e, taskId) => {
                e.stopPropagation();
                
                const existing = document.getElementById('active-dropdown');
                if(existing) existing.remove();

                if (state.activeDropdown === taskId) {
                    state.activeDropdown = null;
                    return;
                }

                const task = state.tasks.find(t => t.id === taskId);
                if (!task) return;

                state.activeDropdown = taskId;
                
                const container = document.getElementById(`pic-container-${taskId}`);
                const rect = container.getBoundingClientRect();

                const menu = document.createElement('div');
                menu.id = 'active-dropdown'; 
                menu.className = "fixed bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-xl rounded-lg p-2 z-[9999] w-48 font-inter";
                
                const dropdownHeight = 200; 
                const spaceBelow = window.innerHeight - rect.bottom;
                
                if (spaceBelow < dropdownHeight) {
                     menu.style.left = `${rect.left}px`;
                     menu.style.bottom = `${window.innerHeight - rect.top + 5}px`; 
                     menu.style.top = 'auto';
                } else {
                     menu.style.left = `${rect.left}px`;
                     menu.style.top = `${rect.bottom + 5}px`;
                }
                
                menu.onclick = (ev) => ev.stopPropagation();
                
                menu.innerHTML = `<div class="text-[10px] text-gray-400 dark:text-slate-500 font-bold mb-2 uppercase tracking-wider px-2">Assign People</div>`;
                
                const createOption = (abbr, name, color, isSelected) => {
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-xs transition-colors ${isSelected ? 'bg-blue-50 dark:bg-slate-700' : 'hover:bg-gray-50 dark:hover:bg-slate-700'}`;
                    item.onclick = () => {
                        if (task.pics.includes(abbr)) {
                            task.pics = task.pics.filter(x => x !== abbr);
                        } else {
                            task.pics.push(abbr);
                        }
                        
                        const trigger = container.querySelector('.flex');
                        App.updatePicDisplay(trigger, task, !task.activityNo.includes('.'));
                        
                        state.activeDropdown = null; 
                        App.openPicDropdown(e, taskId);
                        
                        App.renderChart();
                        App.autoSave();
                    };
                    
                    item.innerHTML = `
                        <div class="check-box w-4 h-4 border rounded-sm flex items-center justify-center ${isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-300 dark:border-slate-600'}">
                            ${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                        </div>
                        <div class="flex-1 flex items-center gap-2">
                            <span class="font-bold" style="color: ${color}">${abbr}</span>
                        </div>
                    `;
                    return item;
                };

                const isAll = task.pics.includes('ALL');
                menu.appendChild(createOption('ALL', 'All Roles', state.darkMode ? '#e2e8f0' : '#000000', isAll));

                state.config.picMap.forEach(p => {
                    const isSelected = task.pics.includes(p.abbr);
                    menu.appendChild(createOption(p.abbr, p.name, p.color, isSelected));
                });

                document.body.appendChild(menu);
                lucide.createIcons();
            },

            renderChart: () => {
                const header = document.getElementById('chart-header');
                const bars = document.getElementById('chart-bars');
                const todayLine = document.getElementById('today-line');
                
                const scrollT = document.getElementById('chart-pane').scrollTop;

                header.innerHTML = '';
                bars.innerHTML = '';
                
                if (state.tasks.length === 0) return;

                let validTasks = state.tasks.filter(t => t.startDate && t.duration);
                if (validTasks.length === 0) {
                     validTasks = [{startDate: new Date().toISOString().split('T')[0], duration: 1}];
                }

                const starts = validTasks.map(t => new Date(t.startDate));
                const ends = validTasks.map(t => new Date(addDays(t.startDate, t.duration + 5)));
                const minDate = new Date(Math.min(...starts));
                minDate.setDate(minDate.getDate() - 2);
                const maxDate = new Date(Math.max(...ends));

                const timelineDays = [];
                let curr = new Date(minDate);
                while(curr <= maxDate) {
                    timelineDays.push(new Date(curr));
                    curr.setDate(curr.getDate() + 1);
                }

                document.getElementById('chart-content').style.width = `${timelineDays.length * state.zoom}px`;

                // Render Header (Months and Days)
                let currentMonth = -1;
                let monthLabel = "";
                
                header.className = "flex flex-col border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 sticky top-0 z-10 header-height shadow-sm";
                header.innerHTML = `
                    <div id="header-months" class="flex border-b border-gray-200 dark:border-slate-700 h-1/2 overflow-hidden"></div>
                    <div id="header-days" class="flex h-1/2"></div>
                `;
                const monthRow = document.getElementById('header-months');
                const dayRow = document.getElementById('header-days');

                let monthBuffer = [];
                
                timelineDays.forEach((date, i) => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = "flex-shrink-0 border-r border-gray-200 dark:border-slate-700 flex flex-col items-center justify-center text-[10px] text-gray-500 dark:text-slate-400 select-none";
                    dayDiv.style.width = `${state.zoom}px`;
                    dayDiv.innerHTML = `<span class="font-bold">${date.getDate()}</span><span class="text-[8px]">${date.toLocaleDateString('en-US', { weekday: 'narrow' })}</span>`;
                    dayRow.appendChild(dayDiv);

                    if (currentMonth !== date.getMonth()) {
                         if (monthBuffer.length > 0) {
                             const mDiv = document.createElement('div');
                             mDiv.className = "flex items-center pl-2 text-xs font-bold text-gray-600 dark:text-slate-300 border-r border-gray-200 dark:border-slate-700 whitespace-nowrap overflow-hidden";
                             mDiv.style.width = `${monthBuffer.length * state.zoom}px`;
                             mDiv.innerText = monthLabel;
                             monthRow.appendChild(mDiv);
                         }
                         currentMonth = date.getMonth();
                         monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                         monthBuffer = [date];
                    } else {
                        monthBuffer.push(date);
                    }
                    
                    if (i === timelineDays.length - 1 && monthBuffer.length > 0) {
                         const mDiv = document.createElement('div');
                         mDiv.className = "flex items-center pl-2 text-xs font-bold text-gray-600 dark:text-slate-300 border-r border-gray-200 dark:border-slate-700 whitespace-nowrap overflow-hidden";
                         mDiv.style.width = `${monthBuffer.length * state.zoom}px`;
                         mDiv.innerText = monthLabel;
                         monthRow.appendChild(mDiv);
                    }
                });

                state.tasks.forEach((task, index) => {
                    const tableRow = document.getElementById(`tr-${task.id}`);
                    const rowHeight = tableRow ? tableRow.getBoundingClientRect().height : 52;
                    
                    const row = document.createElement('div');
                    const isPhase = !task.activityNo.includes('.');
                    const borderTop = isPhase ? `border-top: 1px solid #cbd5e1;` : '';
                    row.className = "relative w-full border-b border-dashed border-gray-100 dark:border-slate-700 flex items-center group hover:bg-white/50 dark:hover:bg-slate-800/50";
                    row.style.height = `${rowHeight}px`; 
                    row.style.cssText += borderTop;

                    if (task.startDate && task.duration) {
                        const startOffset = getDaysDiff(timelineDays[0], task.startDate);
                        const level = getTaskLevel(task.activityNo);
                        const barColor = getThemeColor(state.config.themeColor, level);
                        const isCompleted = task.status === 'Completed';

                        const bar = document.createElement('div');
                        bar.className = `absolute h-6 rounded-sm text-xs flex items-center px-2 truncate transition-all duration-300 cursor-pointer hover:brightness-110 hover:shadow-md ${isCompleted ? 'shadow-sm' : ''}`;
                        bar.style.left = `${startOffset * state.zoom}px`;
                        bar.style.width = `${task.duration * state.zoom}px`;
                        bar.style.backgroundColor = isCompleted ? barColor : `${barColor}15`;
                        bar.style.border = isCompleted ? 'none' : `2px dashed ${barColor}`;
                        bar.style.color = isCompleted ? 'white' : barColor;
                        
                        bar.onmouseenter = (e) => App.showTooltip(e, task);
                        bar.onmousemove = (e) => App.moveTooltip(e);
                        bar.onmouseleave = () => document.getElementById('custom-tooltip').classList.add('hidden');
                        
                        row.appendChild(bar);
                    }
                    bars.appendChild(row);
                });
                
                const spacer = document.createElement('div');
                spacer.className = "h-24 w-full bg-transparent";
                bars.appendChild(spacer);
                
                document.getElementById('chart-pane').scrollTop = scrollT;
                
                const today = new Date();
                const offset = getDaysDiff(timelineDays[0], today);
                if (offset >= 0 && offset < timelineDays.length) {
                    todayLine.style.display = 'block';
                    todayLine.style.left = `${(offset * state.zoom) + (state.zoom/2)}px`;
                    todayLine.style.top = '0px'; 
                } else { todayLine.style.display = 'none'; }
            },

            renderConfigPanel: () => {
                const c = document.getElementById('legend-content');
                c.innerHTML = '';
                
                const c1 = document.createElement('div');
                c1.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-2">Theme Base Color</label>
                        <div class="flex items-center gap-3">
                            <input type="color" class="w-10 h-10 rounded border-none cursor-pointer" value="${state.config.themeColor}" oninput="app.updateConfig('themeColor', null, null, this.value)">
                            <span class="text-xs text-gray-500 dark:text-slate-400">Generates activity gradients</span>
                        </div>
                    </div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-3">Hierarchy Preview</h4>`;
                const levels = ["Activity Phase", "Major Activity", "Minor Activity", "Sub-Activity"];
                levels.forEach((name, i) => {
                    const color = getThemeColor(state.config.themeColor, i);
                    c1.innerHTML += `<div class="flex items-center gap-2 mb-2"><div class="w-3 h-3 rounded-sm" style="background:${color}"></div><span class="text-sm text-gray-600 dark:text-slate-300">${name}</span></div>`;
                });
                c.appendChild(c1);
                
                const c2 = document.createElement('div');
                c2.innerHTML = `<h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-3">Status Styles</h4>
                    <div class="space-y-2 text-xs text-gray-500 dark:text-gray-400">
                        Colors are handled by theme now.
                    </div>`;
                c.appendChild(c2);

                const c3 = document.createElement('div');
                const addPicBtn = `<button onclick="app.addConfigItem('pic')" class="text-blue-600 dark:text-blue-400 text-xs font-bold hover:underline ml-2">+ Add</button>`;
                c3.innerHTML = `<h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-3">Team (PIC) ${addPicBtn}</h4><div class="space-y-2"></div>`;
                const picContainer = c3.querySelector('div');
                state.config.picMap.forEach((p, i) => {
                    picContainer.innerHTML += `
                         <div class="flex items-center gap-2">
                             <input type="color" class="w-4 h-4 rounded border-none cursor-pointer p-0" value="${p.color}" oninput="app.updateConfig('picMap', ${i}, 'color', this.value)">
                             <input class="w-10 bg-transparent border-b border-transparent focus:border-gray-300 text-sm font-bold uppercase" value="${p.abbr}" oninput="app.updateConfig('picMap', ${i}, 'abbr', this.value)">
                             <input class="flex-1 bg-transparent border-b border-transparent focus:border-gray-300 text-sm" value="${p.name}" oninput="app.updateConfig('picMap', ${i}, 'name', this.value)">
                             <button onclick="app.removeConfigItem('pic', ${i})" class="text-gray-300 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    `;
                });
                c.appendChild(c3);
                
                lucide.createIcons();
            },

            showTooltip: (e, task) => {
                const tip = document.getElementById('custom-tooltip');
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                document.getElementById('tooltip-title').innerText = `${task.activityNo} ${task.description}`;
                document.getElementById('tooltip-status').innerText = task.status;
                const end = addDays(task.startDate, task.duration - 1);
                document.getElementById('tooltip-date').innerText = `${formatDateDisplay(task.startDate)} - ${formatDateDisplay(end)}`;
                
                const x = e.clientX + 15;
                const y = e.clientY + 15;
                
                if (x + 200 > winW) tip.style.left = `${e.clientX - 215}px`;
                else tip.style.left = `${x}px`;
                
                if (y + 100 > winH) tip.style.top = `${e.clientY - 100}px`;
                else tip.style.top = `${y}px`;

                tip.classList.remove('hidden');
            },

            moveTooltip: (e) => {
                const tip = document.getElementById('custom-tooltip');
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                const x = e.clientX + 15;
                const y = e.clientY + 15;
                
                if (x + 200 > winW) tip.style.left = `${e.clientX - 215}px`;
                else tip.style.left = `${x}px`;
                
                if (y + 100 > winH) tip.style.top = `${e.clientY - 100}px`;
                else tip.style.top = `${y}px`;
            },

            insertTask: (index) => {
                const prev = state.tasks[index];
                const startDate = prev ? prev.startDate : '';
                const newTask = {
                    id: generateId(),
                    activityNo: ((parseFloat(prev?.activityNo) || 0) + 0.1).toFixed(1),
                    description: 'New Activity',
                    startDate: '',
                    duration: '',
                    pics: [],
                    status: 'Pending'
                };
                
                const scrollT = document.getElementById('table-pane').scrollTop;
                
                state.tasks.splice(index + 1, 0, newTask);
                App.renderTable();
                App.renderChart();
                
                document.getElementById('table-pane').scrollTop = scrollT;
                
                setTimeout(() => {
                    const descInput = document.getElementById(`desc-${newTask.id}`);
                    if(descInput) descInput.focus();
                }, 0);
                
                App.autoSave();
            },

            removeTask: (id) => {
                if(confirm('Are you sure you want to delete this activity?')) {
                    const scrollT = document.getElementById('table-pane').scrollTop;
                    
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    App.renderTable();
                    App.renderChart();
                    
                    document.getElementById('table-pane').scrollTop = scrollT;
                    
                    App.autoSave();
                }
            },

            autoSave: () => {
                clearTimeout(state.saveTimer);
                document.getElementById('save-status').innerText = 'Saving...';
                document.getElementById('save-status').className = "text-[10px] text-blue-500 font-bold transition-colors whitespace-nowrap";
                state.saveTimer = setTimeout(() => {
                    App.saveChart(true);
                }, 800); 
            },

            saveChart: async (silent = false) => {
                if(!dbInstance) {
                    if(!silent) alert("Config Missing!\n\nYou have not set your Firebase keys in the code.\nPlease edit index.html lines ~340 and replace placeholders.");
                    document.getElementById('save-status').innerText = "Config Missing";
                    document.getElementById('save-status').className = "text-[10px] text-red-500 font-bold";
                    return;
                }
                
                const idToUse = state.chartId || generateId();
                if(!silent) App.showToast("Saving...", "info");
                
                try {
                    await setDoc(doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', idToUse), {
                        config: state.config,
                        tasks: state.tasks,
                        lastUpdated: new Date().toISOString(),
                        authorId: state.user?.uid || 'anon'
                    });
                    
                    if (!state.chartId) {
                        state.chartId = idToUse;
                        const url = new URL(window.location.href);
                        url.searchParams.set('id', idToUse);
                        window.history.pushState({}, '', url);
                    }
                    
                    if(!silent) App.showToast("Saved!", "success");
                    
                    const d = new Date();
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('save-status').innerText = `Saved ${dateStr}`;
                    document.getElementById('save-status').className = "text-[10px] text-gray-400 dark:text-slate-500 truncate max-w-[200px] whitespace-nowrap";
                    
                } catch(e) {
                    console.error(e);
                    if(!silent) App.showToast("Error saving", "error");
                }
            },

            shareLink: async () => {
                if(!state.chartId) await App.saveChart();
                const url = new URL(window.location.href);
                if(state.chartId) url.searchParams.set('id', state.chartId);
                
                navigator.clipboard.writeText(url.toString()).then(() => {
                    App.showToast("Link Copied!", "success");
                }).catch(() => {
                    prompt("Copy link:", url.toString());
                });
            },

            zoomIn: () => { state.zoom = Math.min(state.zoom + 4, 80); App.updateZoom(); },
            zoomOut: () => { state.zoom = Math.max(state.zoom - 4, 8); App.updateZoom(); },
            handleZoomSubmit: () => {
                const inp = document.getElementById('zoom-input');
                let val = parseInt(inp.value.replace('%', ''));
                if (isNaN(val)) val = 100;
                val = Math.max(20, Math.min(200, val));
                state.zoom = (val / 100) * 40;
                App.updateZoom();
            },
            updateZoom: () => {
                document.getElementById('zoom-input').value = Math.round((state.zoom / 40) * 100) + '%';
                App.renderChart();
            },
            toggleLegend: () => {
                state.showLegend = !state.showLegend;
                const container = document.getElementById('drawer-container');
                const i = document.getElementById('legend-chevron');
                container.classList.toggle('translate-y-full', !state.showLegend);
                i.innerHTML = `<i data-lucide="${state.showLegend ? 'chevron-down' : 'chevron-up'}" class="w-4 h-4"></i>`;
                App.renderConfigPanel(); // Ensure panel is fresh
                lucide.createIcons();
            },
            toggleSettings: () => {
                // Deprecated (Removed button), kept for logic if needed
            },
            
            addConfigItem: (type) => {
                if(type === 'pic') state.config.picMap.push({ abbr: 'NEW', name: 'New Member', color: '#000000' });
                if(type === 'status') state.config.statusMap.push({ name: 'New Status', color: '#000000' });
                App.renderConfigPanel();
                App.renderAll();
                App.autoSave();
            },
            
            removeConfigItem: (type, index) => {
                if(confirm('Delete this item?')) {
                    if(type === 'pic') state.config.picMap.splice(index, 1);
                    if(type === 'status') state.config.statusMap.splice(index, 1);
                    App.renderConfigPanel();
                    App.renderAll();
                    App.autoSave();
                }
            },

            // --- Updated Config Updater ---
            updateConfig: (path, index, field, value) => {
                if (path === 'title') {
                    state.config.title = value;
                    document.getElementById('app-title').value = value;
                }
                if (path === 'picMap') {
                    state.config.picMap[index][field] = value;
                }
                if (path === 'statusMap') {
                    state.config.statusMap[index][field] = value;
                }
                
                if (field === 'color' || path === 'themeColor') {
                    if (path === 'themeColor') state.config.themeColor = value;
                    App.renderChart();
                    App.renderTable();
                    App.renderConfigPanel(); // Visual feedback in panel
                }
                
                App.autoSave();
            },

            showToast: (msg, type) => {
                const t = document.getElementById('toast');
                t.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'}`;
                document.getElementById('toast-message').innerText = msg;
                document.getElementById('toast-icon').innerHTML = type === 'success' ? '<i data-lucide="check" class="w-3 h-3"></i>' : '';
                lucide.createIcons();
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
                t.classList.remove('translate-y-20', 'opacity-0');
            }
        };

        window.app = App;
        App.init();
    </script>
</body>
</html>
