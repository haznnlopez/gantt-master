<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GanttMaster</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hide Date Picker Icon - use click to activate */
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        
        /* Animation */
        @keyframes fade-in { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        
        /* Tooltip Arrow */
        .tooltip-arrow {
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%) translateY(100%);
            width: 0; 
            height: 0; 
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(17, 24, 39, 0.95);
        }
        
        .min-row-height { min-height: 52px; }
        .header-height { height: 50px; }
        
        /* Hover Add Trigger */
        .hover-add-trigger {
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none; /* Ignore clicks when hidden */
        }
        td:hover .hover-add-trigger, .hover-add-trigger:hover {
            opacity: 1;
            pointer-events: auto;
        }

        /* Textarea Auto-height styling */
        .auto-textarea {
            resize: none;
            overflow: hidden;
            min-height: 24px; /* Align with other inputs */
            height: auto;
            display: block;
            line-height: 1.25rem;
            padding-top: 0.1rem;
        }
    </style>
</head>
<body class="bg-white text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="border-b border-gray-200 bg-white px-4 py-3 flex items-center justify-between sticky top-0 z-40 shadow-sm shrink-0">
        <div class="flex items-center gap-3 min-w-0 flex-1">
            <div class="bg-blue-600 p-2 rounded-lg text-white shadow-blue-200 shadow-lg shrink-0">
                <i data-lucide="align-left" class="w-5 h-5"></i>
            </div>
            <div class="flex flex-col min-w-0 flex-1 mr-4">
                <input id="app-title" type="text" class="font-bold text-lg leading-tight tracking-tight outline-none bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded px-1 transition-colors w-full truncate" value="Project Timeline">
                <div class="flex items-center gap-2 text-[10px] text-gray-400 w-full">
                    <input id="app-subtitle" type="text" class="uppercase tracking-widest font-medium outline-none bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded px-1 transition-colors w-full max-w-[250px]" value="GANTTMASTER">
                    <span class="w-px h-3 bg-gray-300 shrink-0"></span>
                    <span id="save-status" class="truncate min-w-0 shrink-0 text-gray-400">Unsaved</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4 shrink-0">
            <!-- Zoom Controls -->
            <div class="hidden md:flex items-center bg-gray-100 rounded-lg p-1">
                <button onclick="app.zoomOut()" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-white rounded transition-colors" title="Zoom Out"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                <input id="zoom-input" type="text" class="bg-transparent text-xs font-bold text-gray-600 outline-none mx-1 w-10 text-center focus:bg-white rounded" value="100%">
                <button onclick="app.zoomIn()" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-white rounded transition-colors" title="Zoom In"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
            </div>

            <div class="h-6 w-px bg-gray-200 hidden md:block"></div>
            
            <button onclick="app.toggleSettings()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors" title="Settings"><i data-lucide="settings" class="w-5 h-5"></i></button>
            
            <div class="flex items-center gap-2">
                <button onclick="app.saveChart()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Save</span></button>
                <button onclick="app.shareLink()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md shadow-blue-200 transition-colors"><i data-lucide="share-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Share</span></button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- Table Pane -->
        <div id="table-pane" class="overflow-y-auto overflow-x-auto border-r border-gray-200 bg-white h-full custom-scrollbar flex-none z-10 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.05)]" style="width: 700px;">
            <table class="w-full text-sm text-left table-fixed min-w-[700px]">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200 sticky top-0 z-20 header-height">
                    <tr>
                        <th class="px-2 align-middle w-14 text-center">#</th>
                        <th class="px-2 align-middle w-40">Activity</th>
                        <th class="px-2 align-middle w-28">Start</th>
                        <th class="px-2 align-middle w-28">End</th>
                        <th class="px-2 align-middle w-12 text-center">Days</th>
                        <th class="px-2 align-middle w-28">PIC</th>
                        <th class="px-2 align-middle w-28">Status</th>
                        <th class="px-2 align-middle w-10"></th>
                    </tr>
                </thead>
                <tbody id="task-table-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Chart Pane -->
        <div id="chart-pane" class="flex-1 overflow-auto bg-gray-50/50 relative custom-scrollbar h-full cursor-grab">
            <div id="chart-content" class="relative pb-20">
                <!-- Header Dates -->
                <div id="chart-header" class="flex border-b border-gray-200 bg-gray-50 sticky top-0 z-10 header-height shadow-sm">
                    <!-- Dates generated by JS -->
                </div>
                <!-- Bars -->
                <div id="chart-bars" class="pt-0">
                    <!-- Bars generated by JS -->
                </div>
                <!-- Today Line -->
                <div id="today-line" class="absolute top-0 bottom-0 border-l-2 border-red-500/40 z-0 pointer-events-none hidden">
                    <div class="bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow-sm absolute -top-1 -left-5 z-20 font-bold tracking-wide">TODAY</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Legend Button -->
    <div class="fixed bottom-6 right-6 z-[60]">
        <button onclick="app.toggleLegend()" class="bg-gray-800 text-white px-4 py-3 rounded-full shadow-xl flex items-center gap-2 text-sm font-bold hover:bg-gray-900 transition-all hover:scale-105">
            <i data-lucide="map" class="w-4 h-4"></i>
            <span>Legend</span>
            <span id="legend-chevron" class="ml-1"><i data-lucide="chevron-up" class="w-4 h-4"></i></span>
        </button>
    </div>

    <!-- Legend Panel -->
    <div id="legend-panel" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] transition-transform duration-300 z-50 translate-y-full">
        <div class="p-6 relative max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <i data-lucide="map" class="w-5 h-5 text-gray-400"></i> Chart Legend
                </h3>
                <button onclick="app.toggleLegend()" class="p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-gray-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="legend-content" class="grid grid-cols-1 md:grid-cols-3 gap-12 pb-4">
                <!-- Legend items generated by JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in flex flex-col max-h-[85vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 shrink-0">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> Configuration</h3>
                <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-gray-600 p-1 rounded hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="settings-content" class="p-6 overflow-y-auto custom-scrollbar">
                <!-- Settings inputs generated by JS -->
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end shrink-0">
                <button onclick="app.toggleSettings()" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition-colors">Done</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <!-- Custom Tooltip -->
    <div id="custom-tooltip" class="hidden fixed z-[100] bg-gray-900/95 backdrop-blur-sm text-white px-3 py-2 rounded-lg shadow-xl text-xs pointer-events-none mt-[-8px]">
        <div id="tooltip-title" class="font-bold mb-1 border-b border-gray-700 pb-1"></div>
        <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1 text-[10px] text-gray-300">
            <span>Status:</span> <span id="tooltip-status" class="text-white font-medium"></span>
            <span>Period:</span> <span id="tooltip-date" class="text-white font-mono"></span>
        </div>
        <div class="tooltip-arrow"></div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // =================================================================================
        // CONFIGURATION: REPLACE THIS SECTION WITH YOUR FIREBASE KEYS FOR GITHUB HOSTING
        // =================================================================================
        
        let firebaseConfig = {
            apiKey: "AIzaSyBaZJ49zEo4GoWR3LoyDba5J3wkPkaOfWs",
            authDomain: "gantt-master.firebaseapp.com",
            projectId: "gantt-master",
            storageBucket: "gantt-master.firebasestorage.app",
            messagingSenderId: "822947741694",
            appId: "1:822947741694:web:41f0828656259cc0200aaf",
            measurementId: "G-2KK6BNYHPP"
        };

        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gantt-master-public';
        // =================================================================================

        let appInstance, authInstance, dbInstance;
        
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
                appInstance = initializeApp(firebaseConfig);
                authInstance = getAuth(appInstance);
                dbInstance = getFirestore(appInstance);
            } else {
                console.warn("Firebase not configured.");
            }
        } catch(e) {
            console.error("Firebase Init Error:", e);
        }

        const state = {
            user: null,
            chartId: null,
            loading: true,
            zoom: 40,
            showLegend: false,
            activeDropdown: null,
            saveTimer: null,
            config: {
                title: "Project Timeline",
                subtitle: "GANTTMASTER",
                themeColor: '#3b82f6', // Default Blue Base Color
                picMap: [
                    { id: '1', abbr: 'TL', name: 'Team Lead', color: '#3b82f6' },
                    { id: '2', abbr: 'DEV', name: 'Developer', color: '#8b5cf6' },
                    { id: '3', abbr: 'DES', name: 'Designer', color: '#ec4899' },
                    { id: '4', abbr: 'QA', name: 'QA Engineer', color: '#f97316' },
                ],
                statusMap: [
                    { id: '1', name: 'Completed', color: '#22c55e' },
                    { id: '2', name: 'In Progress', color: '#eab308' },
                    { id: '3', name: 'Pending', color: '#94a3b8' },
                    { id: '4', name: 'Delayed', color: '#ef4444' },
                ]
            },
            tasks: [
                { id: '1', activityNo: '1.0', description: 'Project Phase', startDate: new Date().toISOString().split('T')[0], duration: 10, pics: ['TL'], status: 'In Progress' },
                { id: '2', activityNo: '1.1', description: 'Major Activity', startDate: new Date().toISOString().split('T')[0], duration: 5, pics: ['DEV'], status: 'Completed' },
            ]
        };

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function formatDate(str) { if(!str) return ''; const d = new Date(str); return d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }); }
        function addDays(str, days) { const d = new Date(str); d.setDate(d.getDate() + parseInt(days)); return d.toISOString().split('T')[0]; }
        function getDaysDiff(start, end) { return Math.round((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)); }
        
        // --- Color Logic ---
        function getTaskLevel(activityNo) {
            if(!activityNo) return 0;
            return (activityNo.match(/\./g) || []).length; 
        }
        
        function adjustBrightness(col, amt) {
            var usePound = false;
            if (col[0] == "#") {
                col = col.slice(1);
                usePound = true;
            }
            var num = parseInt(col,16);
            var r = (num >> 16) + amt;
            if (r > 255) r = 255; else if  (r < 0) r = 0;
            var b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255; else if  (b < 0) b = 0;
            var g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255; else if  (g < 0) g = 0;
            return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16).padStart(6,'0');
        }

        function getThemeColor(baseColor, level) {
            const step = 30; // Brightness step
            const maxLevel = 4;
            const cappedLevel = Math.min(level, maxLevel);
            return adjustBrightness(baseColor, cappedLevel * step);
        }

        const App = {
            init: async () => {
                if (authInstance) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInstance, __initial_auth_token);
                    else await signInAnonymously(authInstance);
                    onAuthStateChanged(authInstance, (u) => { state.user = u; App.loadData(); });
                } else {
                    App.renderAll();
                }

                const tp = document.getElementById('table-pane'), cp = document.getElementById('chart-pane');
                let syncL = false, syncR = false;
                tp.onscroll = function() { if (!syncL) { syncR = true; cp.scrollTop = this.scrollTop; } syncL = false; };
                cp.onscroll = function() { if (!syncR) { syncL = true; tp.scrollTop = this.scrollTop; } syncR = false; };

                document.getElementById('app-title').oninput = (e) => { 
                    state.config.title = e.target.value; 
                    document.title = e.target.value + " | GanttMaster";
                    App.autoSave(); 
                };
                document.getElementById('app-subtitle').oninput = (e) => { 
                    state.config.subtitle = e.target.value; 
                    App.autoSave(); 
                };
                
                const zoomInp = document.getElementById('zoom-input');
                zoomInp.onblur = App.handleZoomSubmit;
                zoomInp.onkeydown = (e) => { if(e.key === 'Enter') App.handleZoomSubmit(); };

                // Click handler to close body-attached dropdowns
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('active-dropdown');
                    if (dropdown && !dropdown.contains(e.target) && !e.target.closest('.pic-dropdown-container')) {
                        dropdown.remove();
                        state.activeDropdown = null;
                    }
                });
            },

            loadData: () => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                
                if (id && dbInstance) {
                    state.chartId = id;
                    const docRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', id);
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if(data.config) state.config = { ...state.config, ...data.config };
                            // Migration: ensure themeColor exists if coming from old version
                            if(!state.config.themeColor) state.config.themeColor = '#3b82f6';
                            
                            if(data.tasks) state.tasks = data.tasks.map(t => ({...t, pics: Array.isArray(t.pics) ? t.pics : []}));
                            App.updateDOMFromState(data.lastUpdated, data.authorId);
                        } else {
                            App.showToast("Chart not found. Starting fresh.", "error");
                            window.history.pushState({}, '', window.location.pathname);
                            state.chartId = null;
                            App.renderAll();
                        }
                    });
                } else {
                    App.renderAll();
                }
            },

            updateDOMFromState: (lastUpdated, authorId) => {
                // Update Window Title
                document.title = state.config.title + " | GanttMaster";

                const titleEl = document.getElementById('app-title');
                if(titleEl && document.activeElement !== titleEl) titleEl.value = state.config.title;
                const subEl = document.getElementById('app-subtitle');
                if(subEl && document.activeElement !== subEl) subEl.value = state.config.subtitle;

                if(lastUpdated) {
                    const d = new Date(lastUpdated);
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('save-status').innerText = `Last Saved: ${dateStr}`;
                }

                const tbody = document.getElementById('task-table-body');
                const existingRows = tbody.querySelectorAll('tr.group');
                if (existingRows.length !== state.tasks.length) {
                    App.renderTable();
                } else {
                    state.tasks.forEach((task, index) => {
                        const setVal = (id, val) => {
                            const el = document.getElementById(id);
                            if(el && el.value != val && document.activeElement !== el) el.value = val;
                        };
                        setVal(`act-${task.id}`, task.activityNo);
                        
                        // Handle textarea
                        const descEl = document.getElementById(`desc-${task.id}`);
                        if(descEl && descEl.value !== task.description && document.activeElement !== descEl) {
                            descEl.value = task.description;
                            descEl.style.height = 'auto';
                            descEl.style.height = descEl.scrollHeight + 'px';
                        }

                        setVal(`start-${task.id}`, task.startDate);
                        setVal(`end-${task.id}`, addDays(task.startDate, task.duration - 1));
                        setVal(`dur-${task.id}`, task.duration);
                        
                        const statusSelect = document.querySelector(`#task-table-body tr:nth-child(${index+1}) select`);
                        if(statusSelect && statusSelect.value !== task.status && document.activeElement !== statusSelect) statusSelect.value = task.status;
                        
                        const picContainer = document.getElementById(`pic-container-${task.id}`);
                        if(picContainer && state.activeDropdown !== task.id) {
                            const trigger = picContainer.querySelector('.flex');
                            App.updatePicDisplay(trigger, task);
                        }
                    });
                }
                App.renderChart();
                App.renderLegend();
            },

            renderAll: () => {
                // Do NOT call renderSettings here to prevent form reset during edits
                App.renderTable();
                App.renderChart();
                App.renderLegend();
                lucide.createIcons();
            },

            renderTable: () => {
                const tbody = document.getElementById('task-table-body');
                tbody.innerHTML = '';

                state.tasks.forEach((task, index) => {
                    const tr = document.createElement('tr');
                    tr.id = `tr-${task.id}`; // Add ID for height sync
                    tr.className = "border-b border-gray-100 hover:bg-gray-50 group transition-colors min-row-height"; // Changed class
                    tr.innerHTML = `
                        <td class="px-2 align-middle text-center relative group/cell">
                            <input id="act-${task.id}" type="text" class="w-full bg-transparent outline-none font-bold text-gray-500 text-center text-xs" value="${task.activityNo}" oninput="app.handleInput('${task.id}', 'activityNo', this.value, this)">
                            <button onclick="app.insertTask(${index})" class="hover-add-trigger absolute bottom-[-10px] left-1/2 transform -translate-x-1/2 bg-white border border-blue-200 text-blue-500 rounded-full w-5 h-5 flex items-center justify-center shadow-sm z-20 hover:bg-blue-50 hover:scale-110 cursor-pointer" title="Add activity below">
                                <i data-lucide="plus" class="w-3 h-3"></i>
                            </button>
                        </td>
                        <td class="px-2 align-middle py-1">
                            <textarea id="desc-${task.id}" rows="1" class="w-full bg-transparent outline-none font-medium text-gray-800 text-sm auto-textarea align-middle resize-none overflow-hidden" oninput="app.handleInput('${task.id}', 'description', this.value, this)">${task.description}</textarea>
                        </td>
                        <td class="px-2 align-middle"><input id="start-${task.id}" type="date" class="bg-transparent outline-none text-gray-600 w-full cursor-pointer text-xs font-mono" value="${task.startDate}" oninput="app.handleInput('${task.id}', 'startDate', this.value, this)"></td>
                        <td class="px-2 align-middle"><input id="end-${task.id}" type="date" class="bg-transparent outline-none text-gray-600 w-full cursor-pointer text-xs font-mono" value="${addDays(task.startDate, task.duration - 1)}" oninput="app.handleInput('${task.id}', 'endDate', this.value, this)"></td>
                        <td class="px-2 align-middle text-center"><input id="dur-${task.id}" type="number" min="1" class="w-full bg-transparent outline-none text-center text-xs font-semibold text-blue-600" value="${task.duration}" oninput="app.handleInput('${task.id}', 'duration', this.value, this)"></td>
                        <td class="px-2 align-middle pic-cell relative"></td>
                        <td class="px-2 align-middle">
                             <select class="bg-transparent outline-none w-full text-xs px-1 py-1 rounded border border-transparent focus:border-gray-300 cursor-pointer" onchange="app.handleInput('${task.id}', 'status', this.value, this)">
                                ${state.config.statusMap.map(s => `<option value="${s.name}" ${task.status === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                             </select>
                        </td>
                        <td class="px-2 align-middle text-center">
                             <button onclick="app.removeTask('${task.id}')" class="text-gray-300 hover:text-red-500 transition-colors p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-50" title="Delete Activity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    const picCell = tr.querySelector('.pic-cell');
                    picCell.appendChild(App.renderPicTrigger(task));
                    tbody.appendChild(tr);
                    
                    // Initial resize for description
                    setTimeout(() => {
                        const ta = document.getElementById(`desc-${task.id}`);
                        if(ta) {
                            ta.style.height = 'auto';
                            ta.style.height = ta.scrollHeight + 'px';
                        }
                    }, 0);
                });
                lucide.createIcons();
                // Ensure chart syncs after DOM update
                setTimeout(App.renderChart, 50);
            },

            handleInput: (id, field, value, element) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;

                if (field === 'description' && element) {
                    element.style.height = 'auto';
                    element.style.height = element.scrollHeight + 'px';
                    task.description = value;
                } else if (field === 'duration') {
                    const dur = parseInt(value) || 1;
                    task.duration = dur;
                    const endInput = document.getElementById(`end-${id}`);
                    if(endInput) endInput.value = addDays(task.startDate, dur - 1);
                } else if (field === 'startDate') {
                    task.startDate = value;
                    const endInput = document.getElementById(`end-${id}`);
                    if(endInput) endInput.value = addDays(value, task.duration - 1);
                } else if (field === 'endDate') {
                    const diff = getDaysDiff(task.startDate, value);
                    const newDur = diff >= 0 ? diff + 1 : 1;
                    task.duration = newDur;
                    const durInput = document.getElementById(`dur-${id}`);
                    if(durInput) durInput.value = newDur;
                } else {
                    task[field] = value;
                }

                App.renderChart();
                App.autoSave();
            },

            renderPicTrigger: (task) => {
                const div = document.createElement('div');
                div.className = "pic-dropdown-container w-full h-full flex items-center";
                div.id = `pic-container-${task.id}`;
                
                const trigger = document.createElement('div');
                trigger.className = "flex flex-wrap gap-1 cursor-pointer min-h-[24px] items-center w-full";
                trigger.onclick = (e) => App.openPicDropdown(e, task);
                
                App.updatePicDisplay(trigger, task);
                div.appendChild(trigger);
                return div;
            },

            updatePicDisplay: (el, task) => {
                el.innerHTML = '';
                if (!task.pics || task.pics.length === 0) {
                    el.innerHTML = `<span class="text-gray-300 italic text-[10px]">Select</span>`;
                } else {
                    task.pics.forEach(abbr => {
                        if (abbr === 'ALL') {
                            const tag = document.createElement('span');
                            tag.className = "text-[10px] font-bold px-1 rounded shadow-sm";
                            tag.style.color = '#000000';
                            tag.style.backgroundColor = '#e2e8f0';
                            tag.style.border = `1px solid #cbd5e1`;
                            tag.innerText = 'ALL';
                            el.appendChild(tag);
                        } else {
                            const conf = state.config.picMap.find(p => p.abbr === abbr) || { color: '#000' };
                            const tag = document.createElement('span');
                            tag.className = "text-[10px] font-bold px-1 rounded shadow-sm";
                            tag.style.color = conf.color;
                            tag.style.backgroundColor = `${conf.color}15`;
                            tag.style.border = `1px solid ${conf.color}30`;
                            tag.innerText = abbr;
                            el.appendChild(tag);
                        }
                    });
                }
            },

            openPicDropdown: (e, task) => {
                e.stopPropagation();
                
                // Close any open dropdowns first
                const existing = document.getElementById('active-dropdown');
                if(existing) existing.remove();

                if (state.activeDropdown === task.id) {
                    state.activeDropdown = null;
                    return;
                }

                state.activeDropdown = task.id;
                
                const container = document.getElementById(`pic-container-${task.id}`);
                const rect = container.getBoundingClientRect();

                const menu = document.createElement('div');
                menu.id = 'active-dropdown'; // Global ID for the body-attached dropdown
                menu.className = "fixed bg-white border border-gray-200 shadow-xl rounded-lg p-2 z-[9999] w-48 font-inter";
                menu.style.left = `${rect.left}px`;
                menu.style.top = `${rect.bottom + 5}px`;
                
                menu.onclick = (ev) => ev.stopPropagation();
                
                menu.innerHTML = `<div class="text-[10px] text-gray-400 font-bold mb-2 uppercase tracking-wider px-2">Assign People</div>`;
                
                // Helper to create options
                const createOption = (abbr, name, color, isSelected) => {
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-xs transition-colors ${isSelected ? 'bg-blue-50' : 'hover:bg-gray-50'}`;
                    item.onclick = () => {
                        if (task.pics.includes(abbr)) {
                            task.pics = task.pics.filter(x => x !== abbr);
                        } else {
                            task.pics.push(abbr);
                        }
                        
                        const trigger = container.querySelector('.flex');
                        App.updatePicDisplay(trigger, task);
                        
                        // Close dropdown by recursively calling (toggling off logic not hit because id matches)
                        // Actually, for multi-select, we want to keep it open.
                        // Best way to refresh content is to just re-open it.
                        state.activeDropdown = null; 
                        App.openPicDropdown(e, task);
                        
                        App.renderChart();
                        App.autoSave();
                    };
                    
                    item.innerHTML = `
                        <div class="check-box w-4 h-4 border rounded-sm flex items-center justify-center ${isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-300'}">
                            ${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                        </div>
                        <div class="flex-1 flex items-center gap-2">
                            <span class="font-bold" style="color: ${color}">${abbr}</span>
                        </div>
                    `;
                    return item;
                };

                // Option: ALL
                const isAll = task.pics.includes('ALL');
                menu.appendChild(createOption('ALL', 'All Roles', '#000000', isAll));

                // Options: Configured PICs
                state.config.picMap.forEach(p => {
                    const isSelected = task.pics.includes(p.abbr);
                    menu.appendChild(createOption(p.abbr, p.name, p.color, isSelected));
                });

                document.body.appendChild(menu);
                lucide.createIcons();
            },

            renderChart: () => {
                const header = document.getElementById('chart-header');
                const bars = document.getElementById('chart-bars');
                const todayLine = document.getElementById('today-line');
                
                header.innerHTML = '';
                bars.innerHTML = '';
                
                if (state.tasks.length === 0) return;

                const starts = state.tasks.map(t => new Date(t.startDate));
                const ends = state.tasks.map(t => new Date(addDays(t.startDate, t.duration + 5)));
                const minDate = new Date(Math.min(...starts));
                minDate.setDate(minDate.getDate() - 2);
                const maxDate = new Date(Math.max(...ends));

                const timelineDays = [];
                let curr = new Date(minDate);
                while(curr <= maxDate) {
                    timelineDays.push(new Date(curr));
                    curr.setDate(curr.getDate() + 1);
                }

                document.getElementById('chart-content').style.width = `${timelineDays.length * state.zoom}px`;

                timelineDays.forEach(date => {
                    const div = document.createElement('div');
                    div.className = "flex-shrink-0 border-r border-gray-200/50 flex flex-col items-center justify-center text-[10px] text-gray-500 select-none";
                    div.style.width = `${state.zoom}px`;
                    div.innerHTML = `<span class="font-bold">${date.getDate()}</span><span>${date.toLocaleDateString('en-US', { weekday: 'narrow' })}</span>`;
                    header.appendChild(div);
                });

                state.tasks.forEach((task, index) => {
                    const startOffset = getDaysDiff(timelineDays[0], task.startDate);
                    const level = getTaskLevel(task.activityNo);
                    const barColor = getThemeColor(state.config.themeColor, level);
                    const isCompleted = task.status === 'Completed';
                    
                    // Sync Height with Table
                    const tableRow = document.getElementById(`tr-${task.id}`);
                    const rowHeight = tableRow ? tableRow.getBoundingClientRect().height : 52;

                    const row = document.createElement('div');
                    row.className = "relative w-full border-b border-dashed border-gray-100 flex items-center group hover:bg-white/50";
                    row.style.height = `${rowHeight}px`; // Dynamic height

                    const bar = document.createElement('div');
                    bar.className = `absolute h-6 rounded-sm text-xs flex items-center px-2 truncate transition-all duration-300 cursor-pointer hover:brightness-110 hover:shadow-md ${isCompleted ? 'shadow-sm' : ''}`;
                    bar.style.left = `${startOffset * state.zoom}px`;
                    bar.style.width = `${task.duration * state.zoom}px`;
                    bar.style.backgroundColor = isCompleted ? barColor : `${barColor}15`;
                    bar.style.border = isCompleted ? 'none' : `2px dashed ${barColor}`;
                    bar.style.color = isCompleted ? 'white' : barColor;
                    
                    bar.onmouseenter = (e) => App.showTooltip(e, task);
                    bar.onmousemove = (e) => App.moveTooltip(e);
                    bar.onmouseleave = () => document.getElementById('custom-tooltip').classList.add('hidden');
                    
                    row.appendChild(bar);
                    bars.appendChild(row);
                });
                
                const buf = document.createElement('div');
                buf.className = "row-height border-b border-transparent";
                bars.appendChild(buf);

                const today = new Date();
                const offset = getDaysDiff(timelineDays[0], today);
                if (offset >= 0 && offset < timelineDays.length) {
                    todayLine.style.display = 'block';
                    todayLine.style.left = `${(offset * state.zoom) + (state.zoom/2)}px`;
                } else { todayLine.style.display = 'none'; }
            },

            renderLegend: () => {
                const c = document.getElementById('legend-content');
                c.innerHTML = '';
                
                const c1 = document.createElement('div');
                c1.innerHTML = `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Hierarchy Colors</h4>`;
                const levels = ["Activity Phase", "Major Activity", "Minor Activity", "Sub-Activity"];
                levels.forEach((name, i) => {
                    const color = getThemeColor(state.config.themeColor, i);
                    c1.innerHTML += `<div class="flex items-center gap-2 mb-2"><div class="w-3 h-3 rounded-sm" style="background:${color}"></div><span class="text-sm text-gray-600">${name}</span></div>`;
                });
                c.appendChild(c1);
                
                const c2 = document.createElement('div');
                c2.innerHTML = `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Status</h4><div class="space-y-2"><div class="flex items-center gap-3"><div class="w-16 h-4 rounded-full bg-gray-400 flex items-center justify-center text-[8px] text-white">Solid</div><span class="text-sm text-gray-600">Completed</span></div><div class="flex items-center gap-3"><div class="w-16 h-4 rounded-full bg-gray-100 border-2 border-dashed border-gray-400 flex items-center justify-center text-[8px] text-gray-700">Dashed</div><span class="text-sm text-gray-600">Ongoing</span></div></div>`;
                c.appendChild(c2);

                const c3 = document.createElement('div');
                c3.innerHTML = `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">PIC</h4><div class="grid grid-cols-2 gap-2"></div>`;
                const grid = c3.querySelector('.grid');
                state.config.picMap.forEach(p => grid.innerHTML += `<div class="flex items-center gap-2"><span class="text-xs font-bold px-1.5 py-0.5 rounded" style="background:${p.color}20; color:${p.color}">${p.abbr}</span><span class="text-sm text-gray-600">${p.name}</span></div>`);
                c.appendChild(c3);
            },

            showTooltip: (e, task) => {
                const tip = document.getElementById('custom-tooltip');
                document.getElementById('tooltip-title').innerText = `${task.activityNo} ${task.description}`;
                document.getElementById('tooltip-status').innerText = task.status;
                const end = addDays(task.startDate, task.duration - 1);
                document.getElementById('tooltip-date').innerText = `${formatDate(task.startDate)} - ${formatDate(end)}`;
                // Position initial
                tip.style.left = `${e.clientX}px`;
                tip.style.top = `${e.clientY}px`;
                tip.classList.remove('hidden');
            },

            moveTooltip: (e) => {
                const tip = document.getElementById('custom-tooltip');
                tip.style.left = `${e.clientX}px`;
                tip.style.top = `${e.clientY}px`;
            },

            insertTask: (index) => {
                const prev = state.tasks[index];
                const startDate = prev ? prev.startDate : new Date().toISOString().split('T')[0];
                const newTask = {
                    id: generateId(),
                    activityNo: ((parseFloat(prev?.activityNo) || 0) + 0.1).toFixed(1),
                    description: 'New Activity',
                    startDate: startDate,
                    duration: 1,
                    pics: [],
                    status: 'Pending'
                };
                state.tasks.splice(index + 1, 0, newTask);
                App.renderTable();
                App.renderChart();
                App.autoSave();
            },

            removeTask: (id) => {
                if(confirm('Are you sure you want to delete this activity?')) {
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    App.renderTable();
                    App.renderChart();
                    App.autoSave();
                }
            },

            autoSave: () => {
                clearTimeout(state.saveTimer);
                document.getElementById('save-status').innerText = 'Saving...';
                document.getElementById('save-status').className = "text-[10px] text-blue-500 font-bold transition-colors whitespace-nowrap";
                state.saveTimer = setTimeout(() => {
                    App.saveChart(true);
                }, 800); 
            },

            saveChart: async (silent = false) => {
                if(!dbInstance) return;
                const idToUse = state.chartId || generateId();
                if(!silent) App.showToast("Saving...", "info");
                
                try {
                    await setDoc(doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', idToUse), {
                        config: state.config,
                        tasks: state.tasks,
                        lastUpdated: new Date().toISOString(),
                        authorId: state.user?.uid || 'anon'
                    });
                    
                    if (!state.chartId) {
                        state.chartId = idToUse;
                        const url = new URL(window.location.href);
                        url.searchParams.set('id', idToUse);
                        window.history.pushState({}, '', url);
                    }
                    
                    if(!silent) App.showToast("Saved!", "success");
                    
                    const d = new Date();
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('save-status').innerText = `Saved ${dateStr}`;
                    document.getElementById('save-status').className = "text-[10px] text-gray-400 truncate max-w-[200px] whitespace-nowrap";
                    
                } catch(e) {
                    console.error(e);
                    if(!silent) App.showToast("Error saving", "error");
                }
            },

            shareLink: async () => {
                if(!state.chartId) await App.saveChart();
                const url = new URL(window.location.href);
                if(state.chartId) url.searchParams.set('id', state.chartId);
                
                navigator.clipboard.writeText(url.toString()).then(() => {
                    App.showToast("Link Copied!", "success");
                }).catch(() => {
                    prompt("Copy link:", url.toString());
                });
            },

            zoomIn: () => { state.zoom = Math.min(state.zoom + 4, 80); App.updateZoom(); },
            zoomOut: () => { state.zoom = Math.max(state.zoom - 4, 8); App.updateZoom(); },
            handleZoomSubmit: () => {
                const inp = document.getElementById('zoom-input');
                let val = parseInt(inp.value.replace('%', ''));
                if (isNaN(val)) val = 100;
                val = Math.max(20, Math.min(200, val));
                state.zoom = (val / 100) * 40;
                App.updateZoom();
            },
            updateZoom: () => {
                document.getElementById('zoom-input').value = Math.round((state.zoom / 40) * 100) + '%';
                App.renderChart();
            },
            toggleLegend: () => {
                state.showLegend = !state.showLegend;
                const p = document.getElementById('legend-panel');
                const i = document.getElementById('legend-chevron');
                p.classList.toggle('translate-y-full', !state.showLegend);
                i.innerHTML = `<i data-lucide="${state.showLegend ? 'chevron-down' : 'chevron-up'}" class="w-4 h-4"></i>`;
                lucide.createIcons();
            },
            toggleSettings: () => {
                document.getElementById('settings-modal').classList.toggle('hidden');
                if(!document.getElementById('settings-modal').classList.contains('hidden')) App.renderSettings();
            },
            
            addConfigItem: (type) => {
                if(type === 'pic') state.config.picMap.push({ abbr: 'NEW', name: 'New Member', color: '#000000' });
                if(type === 'status') state.config.statusMap.push({ name: 'New Status', color: '#000000' });
                App.renderSettings();
                App.renderAll();
                App.autoSave();
            },
            
            removeConfigItem: (type, index) => {
                if(confirm('Delete this item?')) {
                    if(type === 'pic') state.config.picMap.splice(index, 1);
                    if(type === 'status') state.config.statusMap.splice(index, 1);
                    App.renderSettings();
                    App.renderAll();
                    App.autoSave();
                }
            },

            // --- Updated Config Updater ---
            updateConfig: (path, index, field, value) => {
                if (path === 'title') {
                    state.config.title = value;
                    document.getElementById('app-title').value = value;
                }
                if (path === 'picMap') {
                    state.config.picMap[index][field] = value;
                }
                if (path === 'statusMap') {
                    state.config.statusMap[index][field] = value;
                }
                
                // For colors, we want immediate visual feedback
                if (field === 'color' || path === 'themeColor') {
                    if (path === 'themeColor') state.config.themeColor = value;
                    App.renderChart();
                    App.renderLegend();
                }
                
                App.autoSave();
            },

            renderSettings: () => {
                const c = document.getElementById('settings-content');
                c.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Chart Title</label>
                            <input class="w-full border rounded px-3 py-2 text-sm" value="${state.config.title}" oninput="app.updateConfig('title', null, null, this.value)">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Theme Base Color (For Activities)</label>
                            <div class="flex items-center gap-3">
                                <input type="color" class="w-10 h-10 rounded border-none cursor-pointer" value="${state.config.themeColor}" oninput="app.updateConfig('themeColor', null, null, this.value)">
                                <span class="text-xs text-gray-400">Activity colors are auto-generated gradients of this color.</span>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-xs font-bold text-gray-500">Team Members</label>
                                <button onclick="app.addConfigItem('pic')" class="text-blue-600 text-xs font-bold hover:underline">+ Add Member</button>
                            </div>
                            ${state.config.picMap.map((p, i) => `
                                <div class="flex gap-2 mb-2 items-center">
                                    <input class="w-16 border rounded px-2 py-1 text-sm uppercase" value="${p.abbr}" oninput="app.updateConfig('picMap', ${i}, 'abbr', this.value)">
                                    <input class="flex-1 border rounded px-2 py-1 text-sm" value="${p.name}" oninput="app.updateConfig('picMap', ${i}, 'name', this.value)">
                                    <input type="color" class="w-8 h-8 rounded border-none cursor-pointer" value="${p.color}" oninput="app.updateConfig('picMap', ${i}, 'color', this.value)">
                                    <button onclick="app.removeConfigItem('pic', ${i})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-xs font-bold text-gray-500">Statuses</label>
                                <button onclick="app.addConfigItem('status')" class="text-blue-600 text-xs font-bold hover:underline">+ Add Status</button>
                            </div>
                            ${state.config.statusMap.map((s, i) => `
                                <div class="flex gap-2 mb-2 items-center">
                                    <input class="flex-1 border rounded px-2 py-1 text-sm" value="${s.name}" oninput="app.updateConfig('statusMap', ${i}, 'name', this.value)">
                                    <input type="color" class="w-8 h-8 rounded border-none cursor-pointer" value="${s.color}" oninput="app.updateConfig('statusMap', ${i}, 'color', this.value)">
                                    <button onclick="app.removeConfigItem('status', ${i})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },
            showToast: (msg, type) => {
                const t = document.getElementById('toast');
                t.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'}`;
                document.getElementById('toast-message').innerText = msg;
                document.getElementById('toast-icon').innerHTML = type === 'success' ? '<i data-lucide="check" class="w-3 h-3"></i>' : '';
                lucide.createIcons();
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
                t.classList.remove('translate-y-20', 'opacity-0');
            }
        };

        window.app = App;
        App.init();
    </script>
</body>
</html>
