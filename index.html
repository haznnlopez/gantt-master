<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GanttMaster</title>
    <!-- Tab Icon (Favicon) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            750: '#293548',
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    cursor: {
                        'col-resize': 'col-resize',
                        'grab': 'grab',
                        'grabbing': 'grabbing',
                    },
                    transitionProperty: {
                        'height': 'height',
                        'spacing': 'margin, padding',
                        'width': 'width',
                        'opacity': 'opacity',
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style id="dynamic-theme-style">
        /* Dynamic Theme Variables will be injected here */
        :root {
            --theme-color: #f472b6;
            --theme-light: #fbcfe8;
            --theme-dark: #db2777;
            --theme-bg-light: #fdf2f8; 
        }
    </style>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* --- Rounded Scrollbar Fix --- */
        .custom-scrollbar {
            overflow: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--theme-light) transparent; 
        }
        
        .custom-scrollbar::-webkit-scrollbar { 
            width: 8px; /* Thinner */
            height: 8px; 
        }
        
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: transparent;
            margin: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background-color: var(--theme-light);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
            background-color: var(--theme-color);
        }
        
        /* Circular Color Picker Styling */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            padding: 0;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0; 
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        /* Hide Date Picker Icon */
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
        
        /* Animation */
        @keyframes fade-in { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        
        /* Tooltip */
        .tooltip-box {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .min-row-height { min-height: 52px; }
        .header-height { height: 70px; }
        
        /* Hover Add Trigger */
        .hover-add-trigger {
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none; 
        }
        td:hover .hover-add-trigger, .hover-add-trigger:hover {
            opacity: 1;
            pointer-events: auto;
        }

        /* Textarea Auto-height styling */
        .auto-textarea {
            resize: none;
            overflow: hidden;
            min-height: 24px; 
            height: auto;
            display: block;
            line-height: 1.25rem;
            padding-top: 0.1rem;
        }

        /* Resizer Handle */
        .resizer {
            width: 5px;
            cursor: col-resize;
            background-color: #e2e8f0;
            transition: background-color 0.2s;
            z-index: 40; /* Lower than drawer */
            flex-shrink: 0;
        }
        .dark .resizer { background-color: #334155; }
        .resizer:hover, .resizer.resizing {
            background-color: var(--theme-color);
        }

        /* Parent Row Styling */
        .parent-row input, .parent-row textarea, .parent-row select {
            font-weight: 700;
            color: #1e293b;
        }
        .dark .parent-row input, .dark .parent-row textarea, .dark .parent-row select {
            color: #e2e8f0;
        }
        .parent-row {
            background-color: #f8fafc;
        }
        .dark .parent-row {
            background-color: #1e293b;
        }
        
        /* Fix for status dropdown z-index */
        .status-dropdown-container, .pic-dropdown-container {
            position: relative;
        }

        /* Dynamic Classes */
        .theme-text { color: var(--theme-color) !important; }
        .theme-bg { background-color: var(--theme-color) !important; }
        .theme-bg-light { background-color: var(--theme-bg-light) !important; }
        .theme-border { border-color: var(--theme-color) !important; }
        .theme-hover-bg:hover { background-color: var(--theme-bg-light) !important; }
        .theme-hover-text:hover { color: var(--theme-color) !important; }
        .theme-btn {
            background-color: var(--theme-color);
            color: white;
        }
        .theme-btn:hover {
            filter: brightness(0.9);
        }
        .theme-icon-bg {
            background: linear-gradient(135deg, var(--theme-color), var(--theme-dark));
        }
        .theme-shadow {
            box-shadow: 0 4px 6px -1px var(--theme-light), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        
        /* Top Drawer Styling */
        #drawer-wrapper {
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #drawer-content {
            transition: opacity 0.2s ease;
        }
        
        /* Tab Transitions */
        .tab-content {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
            transition: all 0.3s ease;
            max-width: 0;
            opacity: 0;
        }
        
        /* Open State (Class added via JS) */
        #drawer-wrapper.is-open .tab-content {
            max-width: 200px;
            opacity: 1;
        }
        
        /* Hover State (Only when NOT open) */
        #drawer-wrapper:not(.is-open) #drawer-tab:hover .tab-content {
            max-width: 200px;
            opacity: 1;
        }

        /* Resizing Smoother Classes */
        .resizing-active {
            user-select: none;
            pointer-events: none; /* Disables hover effects while dragging */
        }
        body.resizing-active * {
            cursor: col-resize !important;
        }
        
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing !important; }
    </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 h-screen flex flex-col overflow-hidden transition-colors duration-200">

    <!-- Navbar -->
    <nav class="border-b border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-4 py-3 flex items-center justify-between sticky top-0 z-[60] shadow-sm shrink-0 transition-colors duration-200 relative">
        <div class="flex items-center gap-3 min-w-0 flex-1">
            <div class="theme-icon-bg p-2 rounded-lg text-white shadow-lg shrink-0">
                <i data-lucide="align-left" class="w-5 h-5"></i>
            </div>
            <div class="flex flex-col min-w-0 flex-1 mr-4">
                <input id="app-title" type="text" class="font-bold text-lg leading-tight tracking-tight outline-none bg-transparent hover:bg-gray-50 dark:hover:bg-slate-700 focus:bg-gray-50 dark:focus:bg-slate-700 rounded px-1 transition-colors w-full truncate text-slate-800 dark:text-slate-100" value="Pastel Project">
                <div class="flex items-center gap-2 text-[10px] text-gray-400 w-full">
                    <input id="app-subtitle" type="text" class="uppercase tracking-widest font-medium outline-none bg-transparent hover:bg-gray-50 dark:hover:bg-slate-700 focus:bg-gray-50 dark:focus:bg-slate-700 rounded px-1 transition-colors w-full max-w-[250px]" value="GANTTMASTER">
                    <span class="w-px h-3 bg-gray-300 dark:bg-slate-600 shrink-0"></span>
                    <span id="save-status" class="truncate min-w-0 shrink-0 text-gray-400">Unsaved</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4 shrink-0">
            <!-- Zoom Controls -->
            <div class="hidden md:flex items-center bg-gray-100 dark:bg-slate-700 rounded-lg p-1">
                <button onclick="app.zoomOut()" class="p-1.5 text-gray-500 dark:text-slate-400 theme-hover-text hover:bg-white dark:hover:bg-slate-600 rounded transition-colors" title="Zoom Out"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                <input id="zoom-input" type="text" class="bg-transparent text-xs font-bold text-gray-600 dark:text-slate-200 outline-none mx-1 w-10 text-center focus:bg-white dark:focus:bg-slate-600 rounded" value="100%">
                <button onclick="app.zoomIn()" class="p-1.5 text-gray-500 dark:text-slate-400 theme-hover-text hover:bg-white dark:hover:bg-slate-600 rounded transition-colors" title="Zoom In"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
            </div>
            
            <button onclick="app.toggleDarkMode()" class="p-2 text-gray-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors" title="Toggle Dark Mode">
                <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
            </button>
            
            <div class="flex items-center gap-2">
                <button onclick="app.saveChart()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-slate-200 rounded-lg text-sm font-medium transition-colors"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Save</span></button>
                <button onclick="app.shareLink()" class="theme-btn theme-shadow flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors"><i data-lucide="share-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Share</span></button>
            </div>
        </div>
    </nav>

    <!-- Top Drawer System -->
    <div id="drawer-wrapper" class="absolute top-[65px] left-0 right-0 z-[50] flex flex-col items-center pointer-events-none group">
        
        <!-- The Panel (Hidden by default) -->
        <div id="drawer-panel" class="w-full bg-white/95 dark:bg-slate-800/95 backdrop-blur-md border-b border-gray-200 dark:border-slate-700 shadow-xl overflow-hidden h-0 transition-[height] duration-300 pointer-events-auto">
            <div class="container mx-auto max-w-6xl p-6 h-full overflow-y-auto custom-scrollbar">
                
                <!-- Theme Warning -->
                <div id="contrast-warning" class="hidden mb-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-700 text-yellow-700 dark:text-yellow-200 text-xs font-bold flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    <span>Warning: The selected theme color has low contrast with the background.</span>
                </div>

                <div id="legend-content" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Content Injected via JS -->
                </div>
            </div>
        </div>

        <!-- The Tab (Always Visible) -->
        <button id="drawer-tab" onclick="app.toggleConfig()" class="pointer-events-auto bg-white dark:bg-slate-800 border-b border-r border-l border-gray-200 dark:border-slate-700 rounded-b-xl shadow-md flex items-center justify-center px-4 py-1.5 cursor-pointer hover:shadow-lg transition-all transform translate-y-[-1px]">
            <div class="tab-content">
                <i data-lucide="sliders-horizontal" class="w-3 h-3 theme-text"></i>
                <span class="text-[10px] font-bold text-gray-500 dark:text-slate-400 uppercase tracking-wide whitespace-nowrap">Legends & Config</span>
            </div>
            <i id="drawer-chevron" data-lucide="chevron-down" class="w-3 h-3 text-gray-400 ml-1 transition-transform duration-300"></i>
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden relative" id="main-container">
        
        <!-- Table Pane -->
        <div id="table-pane" class="overflow-y-auto overflow-x-auto border-r border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 h-full custom-scrollbar flex-none z-10 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.05)]" style="width: 700px; flex-shrink: 0;">
            <table class="w-full text-sm text-left table-fixed min-w-[700px]">
                <thead class="text-xs text-gray-700 dark:text-slate-400 uppercase bg-gray-50 dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 sticky top-0 z-20 header-height shadow-sm">
                    <tr>
                        <th class="px-2 align-middle w-14 text-center border-r border-gray-100 dark:border-slate-700">#</th>
                        <th class="px-2 align-middle w-40 border-r border-gray-100 dark:border-slate-700">Activity</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">Start</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">End</th>
                        <th class="px-2 align-middle w-12 text-center border-r border-gray-100 dark:border-slate-700">Days</th>
                        <th class="px-2 align-middle w-36 border-r border-gray-100 dark:border-slate-700">PIC</th>
                        <th class="px-2 align-middle w-28 border-r border-gray-100 dark:border-slate-700">Status</th>
                        <th class="px-2 align-middle w-10"></th>
                    </tr>
                </thead>
                <tbody id="task-table-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
            <!-- Bottom Spacer -->
            <div class="h-24 w-full bg-transparent"></div>
        </div>

        <!-- Resizer -->
        <div id="pane-resizer" class="resizer"></div>

        <!-- Chart Pane -->
        <div id="chart-pane" class="flex-1 overflow-auto bg-gray-50/50 dark:bg-slate-900 relative custom-scrollbar h-full cursor-grab">
            <div id="chart-content" class="relative">
                <!-- Header Dates -->
                <div id="chart-header" class="flex border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 sticky top-0 z-10 header-height shadow-sm">
                    <!-- Dates generated by JS -->
                </div>
                <!-- Bars -->
                <div id="chart-bars" class="pt-0">
                    <!-- Bars generated by JS -->
                </div>
                <!-- Today Line -->
                <div id="today-line" class="absolute top-0 bottom-0 border-l-2 border-red-500/40 z-0 pointer-events-none hidden">
                    <div class="bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow-sm absolute -top-1 -left-5 z-20 font-bold tracking-wide">TODAY</div>
                </div>
                <!-- Bottom Spacer - Matches Table Pane -->
                <div class="h-24 w-full bg-transparent"></div>
            </div>
        </div>

    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <!-- Custom Tooltip -->
    <div id="custom-tooltip" class="hidden fixed z-[100] bg-gray-900/95 backdrop-blur-sm text-white px-3 py-2 rounded-lg shadow-xl text-xs pointer-events-none mt-[-8px] tooltip-box min-w-[180px]">
        <div id="tooltip-title" class="font-bold mb-2 border-b border-gray-700 pb-1 text-sm text-white/90"></div>
        <div id="tooltip-body" class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1.5 text-[11px] text-gray-300">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // =================================================================================
        // CONFIGURATION: USER PROVIDED KEYS
        // =================================================================================
        
        let firebaseConfig = {
            apiKey: "AIzaSyBaZJ49zEo4GoWR3LoyDba5J3wkPkaOfWs",
            authDomain: "gantt-master.firebaseapp.com",
            projectId: "gantt-master",
            storageBucket: "gantt-master.firebasestorage.app",
            messagingSenderId: "822947741694",
            appId: "1:822947741694:web:41f0828656259cc0200aaf",
            measurementId: "G-2KK6BNYHPP"
        };

        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gantt-master-public';
        // =================================================================================

        let appInstance, authInstance, dbInstance;
        
        try {
            if (firebaseConfig.apiKey) {
                appInstance = initializeApp(firebaseConfig);
                authInstance = getAuth(appInstance);
                dbInstance = getFirestore(appInstance);
            } else {
                console.warn("Firebase not configured.");
            }
        } catch(e) {
            console.error("Firebase Init Error:", e);
        }

        const state = {
            user: null,
            chartId: null,
            loading: true,
            zoom: 40,
            showLegend: false,
            activeDropdown: null,
            activeStatusDropdown: null, 
            saveTimer: null,
            darkMode: false,
            scrollPos: { table: 0, chart: 0 },
            config: {
                title: "Pastel Project",
                subtitle: "GANTTMASTER",
                themeColor: '#f472b6', 
                paneWidth: 700,
                picMap: [
                    { id: '1', abbr: 'TL', name: 'Team Lead', color: '#fca5a5' },
                    { id: '2', abbr: 'DEV', name: 'Developer', color: '#86efac' },
                    { id: '3', abbr: 'DES', name: 'Designer', color: '#f9a8d4' },
                    { id: '4', abbr: 'QA', name: 'QA Engineer', color: '#fdba74' },
                ],
                statusMap: [
                    { id: '1', name: 'Completed', color: '#86efac' },
                    { id: '2', name: 'In Progress', color: '#fde047' },
                    { id: '3', name: 'Pending', color: '#cbd5e1' },
                    { id: '4', name: 'Delayed', color: '#fca5a5' },
                ]
            },
            tasks: [
                { id: '1', activityNo: '1.0', description: 'Design Phase', startDate: new Date().toISOString().split('T')[0], duration: 10, pics: ['TL'], status: 'In Progress' },
                { id: '2', activityNo: '1.1', description: 'Wireframing', startDate: new Date().toISOString().split('T')[0], duration: 5, pics: ['DES'], status: 'Completed' },
            ]
        };

        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function formatDateDisplay(isoStr) { 
            if(!isoStr) return ''; 
            if(isoStr.includes('/')) return isoStr; 
            const [y, m, d] = isoStr.split('-');
            return `${d}/${m}/${y.slice(2)}`;
        }
        function addDays(str, days) { 
            if(!str) return '';
            const d = new Date(str); 
            if(isNaN(d.getTime())) return '';
            d.setDate(d.getDate() + parseInt(days)); 
            return d.toISOString().split('T')[0]; 
        }
        function getDaysDiff(start, end) { return Math.round((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)); }
        
        function getTaskLevel(activityNo) {
            if(!activityNo) return 0;
            return (activityNo.match(/\./g) || []).length; 
        }
        
        function getContrastYIQ(hexcolor){
            if(!hexcolor) return 'black';
            if(hexcolor.startsWith('#')) hexcolor = hexcolor.substring(1);
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function getLuminance(hex) {
            if(!hex) return 0;
            const c = hex.substring(1);
            const rgb = parseInt(c, 16);
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >> 8) & 0xff;
            const b = (rgb >> 0) & 0xff;
            
            // sRGB luminance conversion
            const [Rs, Gs, Bs] = [r,g,b].map(v => {
                v /= 255;
                return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * Rs + 0.7152 * Gs + 0.0722 * Bs;
        }

        function checkContrast(themeColor, isDarkMode) {
            const themeLum = getLuminance(themeColor);
            const bgLum = isDarkMode ? getLuminance('#0f172a') : getLuminance('#ffffff');
            const contrast = (Math.max(themeLum, bgLum) + 0.05) / (Math.min(themeLum, bgLum) + 0.05);
            return contrast < 3; // Standard warning threshold
        }

        function tintColor(hex, factor) {
            let c = hex.substring(1);
            if(c.length===3) c = c.split('').map(x=>x+x).join('');
            const rgb = parseInt(c, 16);
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >>  8) & 0xff;
            const b = (rgb >>  0) & 0xff;

            const newR = Math.round(r + (255 - r) * factor);
            const newG = Math.round(g + (255 - g) * factor);
            const newB = Math.round(b + (255 - b) * factor);

            return "#" + ((1 << 24) + (newR << 16) + (newG << 8) + newB).toString(16).slice(1);
        }

        function getThemeColor(baseColor, level) {
            const factors = [0, 0.25, 0.5, 0.75, 0.85];
            const factor = factors[Math.min(level, factors.length - 1)];
            return tintColor(baseColor, factor);
        }
        
        function incrementActivityNo(prev) {
            if (!prev) return '1.0';
            const parts = prev.split('.');
            if (parts.length > 1) {
                const last = parts.pop();
                if (!isNaN(last)) {
                    parts.push(parseInt(last) + 1);
                    return parts.join('.');
                }
            } 
            return prev + '.1';
        }

        const App = {
            init: async () => {
                if (authInstance) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInstance, __initial_auth_token);
                    else await signInAnonymously(authInstance);
                    onAuthStateChanged(authInstance, (u) => { state.user = u; App.loadData(); });
                } else {
                    App.renderAll();
                }

                if (localStorage.getItem('gantt-theme') === 'dark' || (!('gantt-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    state.darkMode = true;
                    document.getElementById('theme-icon').setAttribute('data-lucide', 'sun');
                }

                const resizer = document.getElementById('pane-resizer');
                const tablePane = document.getElementById('table-pane');
                
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    document.body.style.cursor = 'col-resize';
                    resizer.classList.add('resizing');
                    document.body.classList.add('resizing-active'); // Smoother, no selection
                    
                    const moveHandler = (moveEvent) => {
                        requestAnimationFrame(() => {
                            const newWidth = moveEvent.clientX;
                            if (newWidth > 300 && newWidth < window.innerWidth - 100) {
                                tablePane.style.width = `${newWidth}px`;
                            }
                        });
                    };

                    const upHandler = (upEvent) => {
                        document.body.style.cursor = '';
                        resizer.classList.remove('resizing');
                        document.body.classList.remove('resizing-active');
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('mouseup', upHandler);
                        
                        const finalWidth = tablePane.getBoundingClientRect().width;
                        state.config.paneWidth = finalWidth;
                        App.autoSave();
                    };

                    document.addEventListener('mousemove', moveHandler);
                    document.addEventListener('mouseup', upHandler);
                });


                const tp = document.getElementById('table-pane'), cp = document.getElementById('chart-pane');
                
                // --- Chart Drag Scroll ---
                let isDown = false;
                let startX, startY, scrollLeft, scrollTop;

                cp.addEventListener('mousedown', (e) => {
                    // Prevent drag on scrollbars/interactive
                    if (e.offsetX > cp.clientWidth || e.offsetY > cp.clientHeight || e.target.closest('.bar-element')) return;
                    isDown = true;
                    cp.classList.add('cursor-grabbing');
                    cp.classList.remove('cursor-grab');
                    startX = e.pageX - cp.offsetLeft;
                    startY = e.pageY - cp.offsetTop;
                    scrollLeft = cp.scrollLeft;
                    scrollTop = cp.scrollTop;
                });
                
                const stopDrag = () => {
                    isDown = false;
                    cp.classList.remove('cursor-grabbing');
                    cp.classList.add('cursor-grab');
                };

                cp.addEventListener('mouseleave', stopDrag);
                cp.addEventListener('mouseup', stopDrag);

                cp.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - cp.offsetLeft;
                    const y = e.pageY - cp.offsetTop;
                    const walkX = (x - startX); 
                    const walkY = (y - startY);
                    cp.scrollLeft = scrollLeft - walkX;
                    cp.scrollTop = scrollTop - walkY;
                });
                // ---------------------------

                let syncL = false, syncR = false;
                tp.onscroll = function() { 
                    if (!syncL) { syncR = true; cp.scrollTop = this.scrollTop; } syncL = false; 
                    state.scrollPos.table = this.scrollTop;
                };
                cp.onscroll = function() { 
                    if (!syncR) { syncL = true; tp.scrollTop = this.scrollTop; } syncR = false; 
                    state.scrollPos.chart = this.scrollTop;
                };

                document.getElementById('app-title').oninput = (e) => { 
                    state.config.title = e.target.value; 
                    document.title = e.target.value + " | GanttMaster";
                    App.autoSave(); 
                };
                document.getElementById('app-subtitle').oninput = (e) => { 
                    state.config.subtitle = e.target.value; 
                    App.autoSave(); 
                };
                
                const zoomInp = document.getElementById('zoom-input');
                zoomInp.onblur = App.handleZoomSubmit;
                zoomInp.onkeydown = (e) => { if(e.key === 'Enter') App.handleZoomSubmit(); };

                // Dropdown Close Logic
                document.addEventListener('click', (e) => {
                    // PIC Dropdown
                    const dropdown = document.getElementById('active-dropdown');
                    if (dropdown && !dropdown.contains(e.target) && !e.target.closest('.pic-dropdown-container')) {
                        dropdown.remove();
                        state.activeDropdown = null;
                    }
                    // Status Dropdown
                    const statusDropdown = document.getElementById('active-status-dropdown');
                    if (statusDropdown && !statusDropdown.contains(e.target) && !e.target.closest('.status-dropdown-container')) {
                        statusDropdown.remove();
                        state.activeStatusDropdown = null;
                    }
                    // Drawer Close if clicked outside
                    const wrapper = document.getElementById('drawer-wrapper');
                    const tab = document.getElementById('drawer-tab');
                    const panel = document.getElementById('drawer-panel');
                    if (state.showLegend && !panel.contains(e.target) && !tab.contains(e.target) && !e.target.closest('.config-control')) {
                        App.toggleConfig();
                    }
                });

                // Global Tooltip Listener
                document.body.addEventListener('mouseover', (e) => {
                    const target = e.target.closest('[data-custom-tooltip]');
                    if (target) {
                        App.showGenericTooltip(e, target);
                    }
                });
                document.body.addEventListener('mousemove', (e) => {
                    const target = e.target.closest('[data-custom-tooltip]');
                    if (target) {
                        App.moveTooltip(e);
                    } else if (!e.target.closest('.bar-element')) { 
                        // Only hide if not over a chart bar (which has its own logic)
                        document.getElementById('custom-tooltip').classList.add('hidden');
                    }
                });
                document.body.addEventListener('mouseout', (e) => {
                     const target = e.target.closest('[data-custom-tooltip]');
                     if(target) document.getElementById('custom-tooltip').classList.add('hidden');
                });
            },

            toggleDarkMode: () => {
                state.darkMode = !state.darkMode;
                const icon = document.getElementById('theme-icon');
                if (state.darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('gantt-theme', 'dark');
                    icon.setAttribute('data-lucide', 'sun');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('gantt-theme', 'light');
                    icon.setAttribute('data-lucide', 'moon');
                }
                App.updateGlobalTheme();
                App.renderConfigPanel();
                App.renderTable(); 
                lucide.createIcons();
            },

            loadData: () => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                
                if (id && dbInstance) {
                    state.chartId = id;
                    const docRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', id);
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if(data.config) state.config = { ...state.config, ...data.config };
                            if(!state.config.themeColor) state.config.themeColor = '#f472b6';
                            if(data.tasks) state.tasks = data.tasks.map(t => ({...t, pics: Array.isArray(t.pics) ? t.pics : []}));
                            if (state.config.paneWidth) {
                                document.getElementById('table-pane').style.width = `${state.config.paneWidth}px`;
                                const tables = document.querySelectorAll('table');
                                tables.forEach(t => t.style.minWidth = `${state.config.paneWidth}px`);
                            }
                            App.identifyParents();
                            App.updateDOMFromState(data.lastUpdated, data.authorId);
                        } else {
                            App.showToast("Chart not found. Starting fresh.", "error");
                            window.history.pushState({}, '', window.location.pathname);
                            state.chartId = null;
                            App.renderAll();
                        }
                    });
                } else {
                    App.renderAll();
                }
            },

            identifyParents: () => {
                state.tasks.forEach(t => t.isParent = false);
                state.tasks.forEach(parent => {
                    const children = state.tasks.filter(child => 
                        child.id !== parent.id && 
                        child.activityNo.startsWith(parent.activityNo + '.')
                    );
                    if(children.length > 0) {
                        parent.isParent = true;
                    }
                });
            },

            updateGlobalTheme: () => {
                const styleEl = document.getElementById('dynamic-theme-style');
                const base = state.config.themeColor;
                const light = tintColor(base, 0.85); // Lighter background tint
                const dark = tintColor(base, -0.2); 
                
                // Helper to darken hex
                const darken = (col, amt) => {
                    col = col.replace(/^#/, '');
                    let num = parseInt(col, 16);
                    let r = (num >> 16) - amt;
                    let g = ((num >> 8) & 0x00FF) - amt;
                    let b = (num & 0x0000FF) - amt;
                    return "#" + (0x1000000 + (r<255?r<1?0:r:255)*0x10000 + (g<255?g<1?0:g:255)*0x100 + (b<255?b<1?0:b:255)).toString(16).slice(1);
                }
                const darkened = darken(base, 20);

                styleEl.innerHTML = `
                    :root {
                        --theme-color: ${base};
                        --theme-light: ${tintColor(base, 0.6)};
                        --theme-dark: ${darkened};
                        --theme-bg-light: ${light};
                    }
                `;
                
                // Contrast Warning
                const isPoor = checkContrast(base, state.darkMode);
                const warn = document.getElementById('contrast-warning');
                if(warn) {
                    if(isPoor) warn.classList.remove('hidden');
                    else warn.classList.add('hidden');
                }
            },

            updateDOMFromState: (lastUpdated, authorId) => {
                App.updateGlobalTheme();
                document.title = state.config.title + " | GanttMaster";
                const titleEl = document.getElementById('app-title');
                if(titleEl && document.activeElement !== titleEl) titleEl.value = state.config.title;
                const subEl = document.getElementById('app-subtitle');
                if(subEl && document.activeElement !== subEl) subEl.value = state.config.subtitle;

                if(lastUpdated) {
                    const d = new Date(lastUpdated);
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('save-status').innerText = `Last Saved: ${dateStr}`;
                }

                const tbody = document.getElementById('task-table-body');
                const existingRows = tbody.querySelectorAll('tr.group');
                if (existingRows.length !== state.tasks.length) {
                    App.renderTable();
                } else {
                    const phaseBg = tintColor(state.config.themeColor, 0.25);
                    const phaseTextColor = getContrastYIQ(phaseBg);
                    
                    state.tasks.forEach((task, index) => {
                        const tr = document.getElementById(`tr-${task.id}`);
                        const isPhase = !task.activityNo.includes('.');
                        const isMajor = task.activityNo.includes('.') && task.activityNo.split('.').length === 2;
                        
                        if(tr) {
                            if(isPhase) {
                                tr.style.backgroundColor = phaseBg;
                                tr.style.color = phaseTextColor; 
                                tr.style.borderTop = "1px solid #fff";
                                const inputs = tr.querySelectorAll('input, textarea, select');
                                inputs.forEach(inp => {
                                    inp.style.color = phaseTextColor;
                                    inp.style.fontWeight = 'bold';
                                });
                            } else if (isMajor) {
                                tr.style.backgroundColor = '';
                                tr.style.color = '';
                                tr.style.borderTop = '';
                                const inputs = tr.querySelectorAll('input, textarea, select');
                                inputs.forEach(inp => {
                                    inp.style.color = '';
                                    inp.style.fontWeight = 'bold';
                                });
                            } else {
                                tr.style.backgroundColor = '';
                                tr.style.color = '';
                                tr.style.borderTop = '';
                                const inputs = tr.querySelectorAll('input, textarea, select');
                                inputs.forEach(inp => {
                                    inp.style.color = '';
                                    inp.style.fontWeight = 'normal';
                                });
                            }
                            if(task.isParent && !tr.classList.contains('parent-row')) tr.classList.add('parent-row');
                            else if(!task.isParent && tr.classList.contains('parent-row')) tr.classList.remove('parent-row');
                        }

                        const setVal = (id, val) => {
                            const el = document.getElementById(id);
                            if(el && el.value != val && document.activeElement !== el) el.value = val;
                        };
                        setVal(`act-${task.id}`, task.activityNo);
                        
                        const descEl = document.getElementById(`desc-${task.id}`);
                        if(descEl && descEl.value !== task.description && document.activeElement !== descEl) {
                            descEl.value = task.description;
                            descEl.style.height = 'auto';
                            descEl.style.height = descEl.scrollHeight + 'px';
                        }

                        const startEl = document.getElementById(`start-${task.id}`);
                        const endEl = document.getElementById(`end-${task.id}`);
                        
                        if(startEl && document.activeElement !== startEl) {
                             if(startEl.type === 'text') startEl.value = task.startDate ? formatDateDisplay(task.startDate) : '';
                             else startEl.value = task.startDate;
                        }

                        const endDateVal = (task.startDate && task.duration) ? addDays(task.startDate, task.duration - 1) : '';
                        if(endEl && document.activeElement !== endEl) {
                            if(endEl.type === 'text') endEl.value = endDateVal ? formatDateDisplay(endDateVal) : '';
                            else endEl.value = endDateVal;
                        }

                        setVal(`dur-${task.id}`, task.duration);
                        
                        const picContainer = document.getElementById(`pic-container-${task.id}`);
                        if(picContainer && state.activeDropdown !== task.id) {
                            const trigger = picContainer.querySelector('.flex');
                            App.updatePicDisplay(trigger, task, isPhase);
                        }

                        const statusContainer = document.getElementById(`status-container-${task.id}`);
                        if(statusContainer && state.activeStatusDropdown !== task.id) {
                            const trigger = statusContainer.querySelector('.flex');
                            App.updateStatusDisplay(trigger, task, isPhase);
                        }
                    });
                }
                App.renderChart();
                App.renderConfigPanel();
            },

            renderAll: () => {
                App.identifyParents();
                App.renderTable();
                App.renderChart();
                App.renderConfigPanel();
                lucide.createIcons();
            },

            renderTable: () => {
                const tbody = document.getElementById('task-table-body');
                const scrollT = document.getElementById('table-pane').scrollTop;
                tbody.innerHTML = '';
                
                const phaseBg = tintColor(state.config.themeColor, 0.25);
                const phaseTextColor = getContrastYIQ(phaseBg);

                state.tasks.forEach((task, index) => {
                    const tr = document.createElement('tr');
                    tr.id = `tr-${task.id}`; 
                    
                    const isPhase = !task.activityNo.includes('.');
                    const isMajor = task.activityNo.includes('.') && task.activityNo.split('.').length === 2;
                    
                    // Row Class - Dotted bottom border for grid effect
                    let rowClass = "border-b border-dotted border-gray-200 dark:border-slate-700 group transition-colors min-row-height";
                    let rowStyle = "";
                    let textClass = "text-gray-500 dark:text-slate-400"; 
                    
                    if (isPhase) {
                        rowClass = "border-b border-white/20 group transition-colors min-row-height"; // Remove standard dotted border for phase, use style
                        rowStyle = `background-color: ${phaseBg}; color: ${phaseTextColor}; border-top: 1px solid #fff;`;
                        textClass = `${phaseTextColor === 'white' ? 'text-white' : 'text-black'} font-bold`;
                    } else if (isMajor) {
                        rowClass += " bg-gray-50 dark:bg-slate-800";
                        textClass = "text-gray-800 dark:text-slate-200 font-bold";
                    } else {
                        rowClass += " hover:bg-gray-50 dark:hover:bg-slate-800";
                    }

                    tr.className = rowClass;
                    tr.style.cssText = rowStyle;
                    
                    // Vertical Borders - Dotted
                    const cellBorder = isPhase ? 'border-none' : 'border-r border-dotted border-gray-200 dark:border-slate-700';

                    const endDateVal = (task.startDate && task.duration) ? addDays(task.startDate, task.duration - 1) : '';
                    const inputClassBase = "w-full bg-transparent outline-none text-center text-xs";
                    const inputClass = isPhase ? `${inputClassBase} ${textClass} placeholder-${phaseTextColor}/70` : `${inputClassBase} ${textClass}`;
                    const descClass = isPhase ? `w-full bg-transparent outline-none text-sm auto-textarea align-middle resize-none overflow-hidden ${textClass}` : `w-full bg-transparent outline-none font-medium text-sm auto-textarea align-middle resize-none overflow-hidden ${textClass}`;
                    
                    const isLast = index === state.tasks.length - 1;
                    const hoverBtn = isLast ? '' : `
                        <button onclick="app.insertTask(${index})" class="hover-add-trigger absolute bottom-[-10px] left-1/2 transform -translate-x-1/2 bg-white dark:bg-slate-700 theme-border theme-text rounded-full w-5 h-5 flex items-center justify-center shadow-sm z-20 theme-hover-bg hover:scale-110 cursor-pointer border" title="Add activity below">
                            <i data-lucide="plus" class="w-3 h-3"></i>
                        </button>`;
                    
                    const delBtnClass = isPhase ? `transition-colors p-1 rounded-full opacity-0 group-hover:opacity-100 text-${phaseTextColor}/70 hover:text-${phaseTextColor} hover:bg-${phaseTextColor}/20` : 'text-gray-300 dark:text-slate-600 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-50 dark:hover:bg-slate-700';

                    tr.innerHTML = `
                        <td class="px-2 align-middle text-center relative group/cell ${cellBorder}">
                            <input id="act-${task.id}" type="text" class="${inputClass}" value="${task.activityNo}" oninput="app.handleInput('${task.id}', 'activityNo', this.value, this)" onchange="app.commitActivityNo('${task.id}', this.value)">
                            ${hoverBtn}
                        </td>
                        <td class="px-2 align-middle py-1 ${cellBorder}">
                            <textarea id="desc-${task.id}" rows="1" class="${descClass}" oninput="app.handleInput('${task.id}', 'description', this.value, this)">${task.description}</textarea>
                        </td>
                        <td class="px-2 align-middle ${cellBorder}">
                            <input id="start-${task.id}" type="text" class="${inputClass.replace('text-center','')}" 
                                value="${task.startDate ? formatDateDisplay(task.startDate) : ''}" 
                                onfocus="(this.type='date');this.showPicker();this.value='${task.startDate || ''}'" 
                                onblur="(this.type='text');this.value=app.formatDateDisplay(this.value);"
                                onchange="app.handleInput('${task.id}', 'startDate', this.value)">
                        </td>
                        <td class="px-2 align-middle ${cellBorder}">
                             <input id="end-${task.id}" type="text" class="${inputClass.replace('text-center','')}" 
                                value="${endDateVal ? formatDateDisplay(endDateVal) : ''}" 
                                onfocus="(this.type='date');this.showPicker();this.value='${endDateVal || ''}'" 
                                onblur="(this.type='text');this.value=app.formatDateDisplay(this.value);"
                                onchange="app.handleInput('${task.id}', 'endDate', this.value)">
                        </td>
                        <td class="px-2 align-middle text-center ${cellBorder}">
                            <input id="dur-${task.id}" type="number" min="1" class="${inputClass}" value="${task.duration}" oninput="app.handleInput('${task.id}', 'duration', this.value, this)">
                        </td>
                        <td class="px-2 align-middle pic-cell relative ${cellBorder}"></td>
                        <td class="px-2 align-middle status-cell relative ${cellBorder}"></td>
                        <td class="px-2 align-middle text-center">
                             <button onclick="app.removeTask('${task.id}')" class="${delBtnClass}" title="Delete Activity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    
                    const picCell = tr.querySelector('.pic-cell');
                    picCell.appendChild(App.renderPicTrigger(task, isPhase));

                    const statusCell = tr.querySelector('.status-cell');
                    statusCell.appendChild(App.renderStatusTrigger(task, isPhase));

                    tbody.appendChild(tr);
                    
                    setTimeout(() => {
                        const ta = document.getElementById(`desc-${task.id}`);
                        if(ta) {
                            ta.style.height = 'auto';
                            ta.style.height = ta.scrollHeight + 'px';
                        }
                    }, 0);
                });
                
                const addRow = document.createElement('tr');
                addRow.className = "row-height";
                addRow.innerHTML = `<td colspan="8" class="px-2 py-2 align-middle"><button onclick="app.addTask()" class="flex items-center gap-2 theme-text text-sm font-medium theme-hover-bg px-3 py-2 rounded-lg w-full transition-colors border border-dashed border-gray-300 dark:border-slate-600"><i data-lucide="plus" class="w-4 h-4"></i> Add Activity</button></td>`;
                tbody.appendChild(addRow);

                lucide.createIcons();
                document.getElementById('table-pane').scrollTop = scrollT;
                setTimeout(App.renderChart, 50);
            },

            formatDateDisplay: formatDateDisplay,
            
            commitActivityNo: (id, value) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;
                task.activityNo = value;
                App.renderTable(); 
                App.autoSave();
            },

            handleInput: (id, field, value, element) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;

                if (field === 'description' && element) {
                    element.style.height = 'auto';
                    element.style.height = element.scrollHeight + 'px';
                    task.description = value;
                } else if (field === 'duration') {
                    const dur = parseInt(value) || 1;
                    task.duration = dur;
                    const endInput = document.getElementById(`end-${id}`);
                    if(endInput && document.activeElement !== endInput) endInput.value = formatDateDisplay(addDays(task.startDate, dur - 1));
                } else if (field === 'startDate') {
                    task.startDate = value;
                    const endInput = document.getElementById(`end-${id}`);
                    if(endInput && document.activeElement !== endInput) endInput.value = formatDateDisplay(addDays(value, task.duration - 1));
                } else if (field === 'endDate') {
                    const diff = getDaysDiff(task.startDate, value);
                    const newDur = diff >= 0 ? diff + 1 : 1;
                    task.duration = newDur;
                    const durInput = document.getElementById(`dur-${id}`);
                    if(durInput) durInput.value = newDur;
                } else if (field === 'activityNo') {
                    task.activityNo = value;
                } else {
                    task[field] = value;
                }

                App.renderChart();
                App.autoSave();
            },

            addTask: () => {
                const last = state.tasks[state.tasks.length-1];
                const startDate = last ? last.startDate : '';
                const nextNo = incrementActivityNo(last?.activityNo);

                const newTask = {
                    id: generateId(),
                    activityNo: nextNo,
                    description: 'New Activity',
                    startDate: startDate,
                    duration: 1,
                    pics: [],
                    status: 'Pending'
                };
                
                const scrollT = document.getElementById('table-pane').scrollTop;
                
                state.tasks.push(newTask);
                App.renderTable();
                App.renderChart();
                
                const tp = document.getElementById('table-pane');
                tp.scrollTop = tp.scrollHeight;
                
                setTimeout(() => {
                    const descInput = document.getElementById(`desc-${newTask.id}`);
                    if(descInput) descInput.focus();
                }, 0);

                App.autoSave();
            },

            // --- PIC LOGIC ---

            renderPicTrigger: (task, isPhase) => {
                const div = document.createElement('div');
                div.className = "pic-dropdown-container w-full h-full flex items-center";
                div.id = `pic-container-${task.id}`;
                
                const trigger = document.createElement('div');
                trigger.className = "flex flex-wrap gap-1 cursor-pointer min-h-[24px] items-center w-full"; 
                trigger.onclick = (e) => App.openPicDropdown(e, task.id);
                
                App.updatePicDisplay(trigger, task, isPhase);
                div.appendChild(trigger);
                return div;
            },

            updatePicDisplay: (el, task, isPhase) => {
                el.innerHTML = '';
                if (!task.pics || task.pics.length === 0) {
                    el.innerHTML = `<span class="${isPhase ? 'text-white/60' : 'text-gray-300 dark:text-slate-500'} italic text-[10px]">Select</span>`;
                } else {
                    task.pics.forEach(abbr => {
                        let text = abbr;
                        let tooltipTitle = "Unassigned";
                        let tooltipDesc = "";
                        let color = '#000';
                        let bgColor = 'transparent';

                        if (abbr === 'ALL') {
                            text = 'ALL';
                            tooltipTitle = 'All Roles';
                            tooltipDesc = 'Assigned to everyone';
                            color = state.darkMode ? '#fff' : '#000';
                            bgColor = state.darkMode ? '#334155' : '#e2e8f0';
                        } else {
                            const conf = state.config.picMap.find(p => p.abbr === abbr) || { color: '#000', name: abbr };
                            text = abbr;
                            tooltipTitle = conf.name;
                            tooltipDesc = `Code: ${abbr}`;
                            bgColor = conf.color;
                            color = getContrastYIQ(bgColor);
                        }

                        const tag = document.createElement('span');
                        tag.className = "text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm border";
                        tag.style.color = color;
                        tag.style.backgroundColor = bgColor; 
                        tag.style.borderColor = 'transparent';
                        tag.innerText = text;
                        
                        // Custom Tooltip Data Attributes
                        tag.setAttribute('data-custom-tooltip', tooltipDesc); 
                        tag.setAttribute('data-tooltip-title', tooltipTitle); 

                        el.appendChild(tag);
                    });
                }
            },

            openPicDropdown: (e, taskId) => {
                e.stopPropagation();
                
                const existing = document.getElementById('active-dropdown');
                if(existing) existing.remove();
                if (document.getElementById('active-status-dropdown')) document.getElementById('active-status-dropdown').remove();

                if (state.activeDropdown === taskId) {
                    state.activeDropdown = null;
                    return;
                }

                const task = state.tasks.find(t => t.id === taskId);
                if (!task) return;

                state.activeDropdown = taskId;
                
                const container = document.getElementById(`pic-container-${taskId}`);
                const rect = container.getBoundingClientRect();

                const menu = document.createElement('div');
                menu.id = 'active-dropdown'; 
                menu.className = "fixed bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 shadow-xl rounded-lg p-2 z-[9999] w-48 font-inter";
                
                const dropdownHeight = 200; 
                const spaceBelow = window.innerHeight - rect.bottom;
                
                if (spaceBelow < dropdownHeight) {
                     menu.style.left = `${rect.left}px`;
                     menu.style.bottom = `${window.innerHeight - rect.top + 5}px`; 
                     menu.style.top = 'auto';
                } else {
                     menu.style.left = `${rect.left}px`;
                     menu.style.top = `${rect.bottom + 5}px`;
                }
                
                menu.onclick = (ev) => ev.stopPropagation();
                
                menu.innerHTML = `<div class="text-[10px] theme-text font-bold mb-2 uppercase tracking-wider px-2">Assign People</div>`;
                
                const createOption = (abbr, name, color, isSelected) => {
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-xs transition-colors ${isSelected ? 'theme-hover-bg bg-gray-50 dark:bg-slate-700' : 'hover:bg-gray-50 dark:hover:bg-slate-700'}`;
                    item.onclick = () => {
                        if (task.pics.includes(abbr)) {
                            task.pics = task.pics.filter(x => x !== abbr);
                        } else {
                            task.pics.push(abbr);
                        }
                        
                        const trigger = container.querySelector('.flex');
                        App.updatePicDisplay(trigger, task, !task.activityNo.includes('.'));
                        
                        state.activeDropdown = null; 
                        App.openPicDropdown(e, taskId);
                        
                        App.renderChart();
                        App.autoSave();
                    };
                    
                    item.innerHTML = `
                        <div class="check-box w-4 h-4 border rounded-full flex items-center justify-center ${isSelected ? 'theme-bg theme-border' : 'border-gray-300 dark:border-slate-600'}">
                            ${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                        </div>
                        <div class="flex-1 flex items-center gap-2">
                            <span class="font-bold" style="color: ${color}">${abbr}</span>
                        </div>
                    `;
                    return item;
                };

                const isAll = task.pics.includes('ALL');
                menu.appendChild(createOption('ALL', 'All Roles', state.darkMode ? '#e2e8f0' : '#000000', isAll));

                state.config.picMap.forEach(p => {
                    const isSelected = task.pics.includes(p.abbr);
                    menu.appendChild(createOption(p.abbr, p.name, p.color, isSelected));
                });

                document.body.appendChild(menu);
                lucide.createIcons();
            },

            // --- STATUS LOGIC (New) ---

            renderStatusTrigger: (task, isPhase) => {
                const div = document.createElement('div');
                div.className = "status-dropdown-container w-full h-full flex items-center";
                div.id = `status-container-${task.id}`;
                
                const trigger = document.createElement('div');
                trigger.className = "flex flex-wrap gap-1 cursor-pointer min-h-[24px] items-center w-full";
                trigger.onclick = (e) => App.openStatusDropdown(e, task.id);
                
                App.updateStatusDisplay(trigger, task, isPhase);
                div.appendChild(trigger);
                return div;
            },

            updateStatusDisplay: (el, task, isPhase) => {
                el.innerHTML = '';
                const sConf = state.config.statusMap.find(s => s.name === task.status) || { color: '#e2e8f0' };
                const textColor = getContrastYIQ(sConf.color);

                const tag = document.createElement('span');
                tag.className = "text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm border w-full text-center truncate";
                tag.style.backgroundColor = sConf.color;
                tag.style.color = textColor;
                tag.style.borderColor = 'transparent';
                tag.innerText = task.status || 'Pending';
                el.appendChild(tag);
            },

            openStatusDropdown: (e, taskId) => {
                e.stopPropagation();
                
                const existing = document.getElementById('active-status-dropdown');
                if(existing) existing.remove();
                if (document.getElementById('active-dropdown')) document.getElementById('active-dropdown').remove();

                if (state.activeStatusDropdown === taskId) {
                    state.activeStatusDropdown = null;
                    return;
                }

                const task = state.tasks.find(t => t.id === taskId);
                if (!task) return;

                state.activeStatusDropdown = taskId;
                
                const container = document.getElementById(`status-container-${taskId}`);
                const rect = container.getBoundingClientRect();

                const menu = document.createElement('div');
                menu.id = 'active-status-dropdown'; 
                menu.className = "fixed bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 shadow-xl rounded-lg p-2 z-[9999] w-48 font-inter";
                
                const dropdownHeight = 200; 
                const spaceBelow = window.innerHeight - rect.bottom;
                
                if (spaceBelow < dropdownHeight) {
                     menu.style.left = `${rect.left}px`;
                     menu.style.bottom = `${window.innerHeight - rect.top + 5}px`; 
                     menu.style.top = 'auto';
                } else {
                     menu.style.left = `${rect.left}px`;
                     menu.style.top = `${rect.bottom + 5}px`;
                }
                
                menu.onclick = (ev) => ev.stopPropagation();
                
                menu.innerHTML = `<div class="text-[10px] theme-text font-bold mb-2 uppercase tracking-wider px-2">Set Status</div>`;
                
                state.config.statusMap.forEach(s => {
                    const isSelected = task.status === s.name;
                    const item = document.createElement('div');
                    item.className = `flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-xs transition-colors ${isSelected ? 'theme-hover-bg bg-gray-50 dark:bg-slate-700' : 'hover:bg-gray-50 dark:hover:bg-slate-700'}`;
                    item.onclick = () => {
                        task.status = s.name;
                        const trigger = container.querySelector('.flex');
                        App.updateStatusDisplay(trigger, task, !task.activityNo.includes('.'));
                        
                        menu.remove();
                        state.activeStatusDropdown = null;
                        
                        App.renderChart();
                        App.autoSave();
                    };
                    
                    item.innerHTML = `
                        <div class="w-3 h-3 rounded-full" style="background: ${s.color}"></div>
                        <span class="font-medium text-slate-700 dark:text-slate-200">${s.name}</span>
                        ${isSelected ? '<i data-lucide="check" class="w-3 h-3 theme-text ml-auto"></i>' : ''}
                    `;
                    menu.appendChild(item);
                });

                document.body.appendChild(menu);
                lucide.createIcons();
            },

            renderChart: () => {
                const header = document.getElementById('chart-header');
                const bars = document.getElementById('chart-bars');
                const todayLine = document.getElementById('today-line');
                
                const scrollT = document.getElementById('chart-pane').scrollTop;

                header.innerHTML = '';
                bars.innerHTML = '';
                
                if (state.tasks.length === 0) return;

                let validTasks = state.tasks.filter(t => t.startDate && t.duration);
                if (validTasks.length === 0) {
                     validTasks = [{startDate: new Date().toISOString().split('T')[0], duration: 1}];
                }

                const starts = validTasks.map(t => new Date(t.startDate));
                const ends = validTasks.map(t => new Date(addDays(t.startDate, t.duration + 5)));
                const minDate = new Date(Math.min(...starts));
                minDate.setDate(minDate.getDate() - 2);
                const maxDate = new Date(Math.max(...ends));

                const timelineDays = [];
                let curr = new Date(minDate);
                while(curr <= maxDate) {
                    timelineDays.push(new Date(curr));
                    curr.setDate(curr.getDate() + 1);
                }

                document.getElementById('chart-content').style.width = `${timelineDays.length * state.zoom}px`;

                // Render Header (Months and Days)
                let currentMonth = -1;
                let monthLabel = "";
                
                header.className = "flex flex-col border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 sticky top-0 z-10 header-height shadow-sm";
                header.innerHTML = `
                    <div id="header-months" class="flex border-b border-gray-200 dark:border-slate-700 h-1/2 overflow-hidden"></div>
                    <div id="header-days" class="flex h-1/2"></div>
                `;
                const monthRow = document.getElementById('header-months');
                const dayRow = document.getElementById('header-days');

                let monthBuffer = [];
                
                timelineDays.forEach((date, i) => {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = "flex-shrink-0 border-r border-gray-200 dark:border-slate-700 flex flex-col items-center justify-center text-[10px] text-gray-500 dark:text-slate-400 select-none";
                    dayDiv.style.width = `${state.zoom}px`;
                    dayDiv.innerHTML = `<span class="font-bold">${date.getDate()}</span><span class="text-[8px]">${date.toLocaleDateString('en-US', { weekday: 'narrow' })}</span>`;
                    dayRow.appendChild(dayDiv);

                    if (currentMonth !== date.getMonth()) {
                         if (monthBuffer.length > 0) {
                             const mDiv = document.createElement('div');
                             mDiv.className = "flex items-center pl-2 text-xs font-bold text-gray-600 dark:text-slate-300 border-r border-gray-200 dark:border-slate-700 whitespace-nowrap overflow-hidden";
                             mDiv.style.width = `${monthBuffer.length * state.zoom}px`;
                             mDiv.innerText = monthLabel;
                             monthRow.appendChild(mDiv);
                         }
                         currentMonth = date.getMonth();
                         monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                         monthBuffer = [date];
                    } else {
                        monthBuffer.push(date);
                    }
                    
                    if (i === timelineDays.length - 1 && monthBuffer.length > 0) {
                         const mDiv = document.createElement('div');
                         mDiv.className = "flex items-center pl-2 text-xs font-bold text-gray-600 dark:text-slate-300 border-r border-gray-200 dark:border-slate-700 whitespace-nowrap overflow-hidden";
                         mDiv.style.width = `${monthBuffer.length * state.zoom}px`;
                         mDiv.innerText = monthLabel;
                         monthRow.appendChild(mDiv);
                    }
                });

                state.tasks.forEach((task, index) => {
                    const tableRow = document.getElementById(`tr-${task.id}`);
                    const rowHeight = tableRow ? tableRow.getBoundingClientRect().height : 52;
                    
                    const row = document.createElement('div');
                    const isPhase = !task.activityNo.includes('.');
                    const borderTop = isPhase ? `border-top: 1px solid #cbd5e1;` : '';
                    row.className = "relative w-full border-b border-dashed border-gray-100 dark:border-slate-700 flex items-center group hover:bg-white/50 dark:hover:bg-slate-800/50 bar-element";
                    row.style.height = `${rowHeight}px`; 
                    row.style.cssText += borderTop;

                    if (task.startDate && task.duration) {
                        const startOffset = getDaysDiff(timelineDays[0], task.startDate);
                        const level = getTaskLevel(task.activityNo);
                        const barColor = getThemeColor(state.config.themeColor, level);
                        const isCompleted = task.status === 'Completed';

                        const bar = document.createElement('div');
                        bar.className = `absolute h-6 rounded-full text-xs flex items-center px-2 truncate transition-all duration-300 cursor-pointer hover:brightness-110 hover:shadow-md ${isCompleted ? 'shadow-sm' : ''} bar-element`;
                        bar.style.left = `${startOffset * state.zoom}px`;
                        bar.style.width = `${task.duration * state.zoom}px`;
                        bar.style.backgroundColor = isCompleted ? barColor : `${barColor}15`;
                        bar.style.border = isCompleted ? 'none' : `2px dashed ${barColor}`;
                        bar.style.color = isCompleted ? 'white' : barColor;
                        
                        bar.setAttribute('data-custom-tooltip', `${task.activityNo} ${task.description}`);
                        
                        // Tooltip data
                        bar.onmouseenter = (e) => App.showChartTooltip(e, task);
                        bar.onmousemove = (e) => App.moveTooltip(e);
                        bar.onmouseleave = () => document.getElementById('custom-tooltip').classList.add('hidden');
                        
                        row.appendChild(bar);
                    }
                    bars.appendChild(row);
                });
                
                // Ensure same height bottom spacer
                const spacer = document.createElement('div');
                spacer.className = "h-24 w-full bg-transparent";
                bars.appendChild(spacer);
                
                document.getElementById('chart-pane').scrollTop = scrollT;
                
                const today = new Date();
                const offset = getDaysDiff(timelineDays[0], today);
                if (offset >= 0 && offset < timelineDays.length) {
                    todayLine.style.display = 'block';
                    todayLine.style.left = `${(offset * state.zoom) + (state.zoom/2)}px`;
                    todayLine.style.top = '0px'; 
                } else { todayLine.style.display = 'none'; }
            },

            renderConfigPanel: () => {
                const c = document.getElementById('legend-content');
                c.innerHTML = '';
                
                const c1 = document.createElement('div');
                c1.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-2">Theme Base Color</label>
                        <div class="flex items-center gap-3">
                            <input type="color" class="w-10 h-10 rounded-full border-none cursor-pointer shadow-sm flex-shrink-0" value="${state.config.themeColor}" oninput="app.updateConfig('themeColor', null, null, this.value)">
                            <span class="text-xs text-gray-500 dark:text-slate-400">Main theme</span>
                        </div>
                    </div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-3">Hierarchy Preview</h4>`;
                const levels = ["Activity Phase", "Major Activity", "Minor Activity", "Sub-Activity"];
                levels.forEach((name, i) => {
                    const color = getThemeColor(state.config.themeColor, i);
                    c1.innerHTML += `<div class="flex items-center gap-2 mb-2"><div class="w-3 h-3 rounded-full" style="background:${color}"></div><span class="text-sm text-gray-600 dark:text-slate-300">${name}</span></div>`;
                });
                c.appendChild(c1);
                
                // Status Config
                const c2 = document.createElement('div');
                const addStatusBtn = `<button onclick="app.addConfigItem('status')" class="theme-text text-xs font-bold hover:underline ml-2">+ Add</button>`;
                c2.innerHTML = `<h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-3">Status Colors ${addStatusBtn}</h4><div class="space-y-3"></div>`;
                const statusContainer = c2.querySelector('div');
                state.config.statusMap.forEach((s, i) => {
                    statusContainer.innerHTML += `
                         <div class="flex items-center gap-3 group">
                             <input type="color" class="w-8 h-8 rounded-full border-none cursor-pointer p-0 flex-shrink-0 shadow-sm" value="${s.color}" oninput="app.updateConfig('statusMap', ${i}, 'color', this.value)">
                             <input class="flex-1 bg-transparent border-b border-gray-200 dark:border-slate-700 focus:border-gray-400 text-sm py-1" value="${s.name}" oninput="app.updateConfig('statusMap', ${i}, 'name', this.value)">
                             <button type="button" onclick="app.removeConfigItem('status', ${i})" class="text-gray-300 hover:text-red-500 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                });
                c.appendChild(c2);

                // PIC Config - Reformatted to match Status
                const c3 = document.createElement('div');
                const addPicBtn = `<button onclick="app.addConfigItem('pic')" class="theme-text text-xs font-bold hover:underline ml-2">+ Add</button>`;
                c3.innerHTML = `<h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase tracking-wider mb-3">Team (PIC) ${addPicBtn}</h4><div class="space-y-3"></div>`;
                const picContainer = c3.querySelector('div');
                state.config.picMap.forEach((p, i) => {
                    picContainer.innerHTML += `
                         <div class="flex items-center gap-3 group">
                             <input type="color" class="w-8 h-8 rounded-full border-none cursor-pointer p-0 flex-shrink-0 shadow-sm" value="${p.color}" oninput="app.updateConfig('picMap', ${i}, 'color', this.value)">
                             <div class="flex-1 flex gap-2">
                                 <input class="w-16 bg-transparent border-b border-gray-200 dark:border-slate-700 focus:border-gray-400 text-sm font-bold uppercase text-center py-1" value="${p.abbr}" oninput="app.updateConfig('picMap', ${i}, 'abbr', this.value)" placeholder="ABBR">
                                 <input class="flex-1 bg-transparent border-b border-gray-200 dark:border-slate-700 focus:border-gray-400 text-sm py-1" value="${p.name}" oninput="app.updateConfig('picMap', ${i}, 'name', this.value)" placeholder="Full Name">
                             </div>
                             <button type="button" onclick="app.removeConfigItem('pic', ${i})" class="text-gray-300 hover:text-red-500 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                });
                c.appendChild(c3);
                
                lucide.createIcons();
            },

            // --- Generic Tooltip System ---
            showGenericTooltip: (e, target) => {
                const text = target.getAttribute('data-custom-tooltip');
                const title = target.getAttribute('data-tooltip-title') || 'Info';
                const tip = document.getElementById('custom-tooltip');
                
                // Matches format of Bar Tooltip
                document.getElementById('tooltip-title').innerText = title;
                document.getElementById('tooltip-body').innerHTML = `
                    <span class="text-gray-400 uppercase tracking-wide text-[9px] font-bold mt-0.5">Description</span>
                    <span class="text-white font-medium col-span-1">${text}</span>
                `;
                
                tip.classList.remove('hidden');
                App.moveTooltip(e);
            },

            // --- Chart Specific Tooltip ---
            showChartTooltip: (e, task) => {
                const tip = document.getElementById('custom-tooltip');
                const end = addDays(task.startDate, task.duration - 1);
                const picNames = task.pics.map(abbr => {
                    if(abbr === 'ALL') return 'All Roles';
                    const p = state.config.picMap.find(x => x.abbr === abbr);
                    return p ? p.name : abbr;
                }).join(', ');

                document.getElementById('tooltip-title').innerText = `${task.activityNo} ${task.description}`;
                document.getElementById('tooltip-body').innerHTML = `
                    <span class="text-gray-400 uppercase tracking-wide text-[9px] font-bold mt-0.5">Status</span> 
                    <span class="text-white font-medium">${task.status}</span>
                    
                    <span class="text-gray-400 uppercase tracking-wide text-[9px] font-bold mt-0.5">Date</span> 
                    <span class="text-white font-mono opacity-90">${formatDateDisplay(task.startDate)} - ${formatDateDisplay(end)}</span>
                    
                    <span class="text-gray-400 uppercase tracking-wide text-[9px] font-bold mt-0.5">Team</span> 
                    <span class="text-white font-medium break-words leading-tight">${picNames || 'Unassigned'}</span>
                `;
                
                tip.classList.remove('hidden');
                App.moveTooltip(e);
            },

            moveTooltip: (e) => {
                const tip = document.getElementById('custom-tooltip');
                const winW = window.innerWidth;
                const winH = window.innerHeight;
                
                // Offset from cursor
                const x = e.clientX + 15;
                const y = e.clientY + 15;
                
                // Adjust if off screen
                let finalX = x;
                let finalY = y;

                if (x + 220 > winW) finalX = e.clientX - 230; 
                if (y + 150 > winH) finalY = e.clientY - 150; 
                
                tip.style.left = `${finalX}px`;
                tip.style.top = `${finalY}px`;
            },

            insertTask: (index) => {
                const prev = state.tasks[index];
                const startDate = prev ? prev.startDate : '';
                const newTask = {
                    id: generateId(),
                    activityNo: ((parseFloat(prev?.activityNo) || 0) + 0.1).toFixed(1),
                    description: 'New Activity',
                    startDate: '',
                    duration: '',
                    pics: [],
                    status: 'Pending'
                };
                
                const scrollT = document.getElementById('table-pane').scrollTop;
                
                state.tasks.splice(index + 1, 0, newTask);
                App.renderTable();
                App.renderChart();
                
                document.getElementById('table-pane').scrollTop = scrollT;
                
                setTimeout(() => {
                    const descInput = document.getElementById(`desc-${newTask.id}`);
                    if(descInput) descInput.focus();
                }, 0);
                
                App.autoSave();
            },

            removeTask: (id) => {
                if(confirm('Are you sure you want to delete this activity?')) {
                    const scrollT = document.getElementById('table-pane').scrollTop;
                    
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    App.renderTable();
                    App.renderChart();
                    
                    document.getElementById('table-pane').scrollTop = scrollT;
                    
                    App.autoSave();
                }
            },

            autoSave: () => {
                clearTimeout(state.saveTimer);
                document.getElementById('save-status').innerText = 'Saving...';
                document.getElementById('save-status').className = "text-[10px] theme-text font-bold transition-colors whitespace-nowrap";
                state.saveTimer = setTimeout(() => {
                    App.saveChart(true);
                }, 800); 
            },

            saveChart: async (silent = false) => {
                if(!dbInstance) {
                    if(!silent) alert("Config Missing!\n\nPlease check console.");
                    document.getElementById('save-status').innerText = "Config Missing";
                    document.getElementById('save-status').className = "text-[10px] text-red-500 font-bold";
                    return;
                }
                
                const idToUse = state.chartId || generateId();
                if(!silent) App.showToast("Saving...", "info");
                
                try {
                    await setDoc(doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', idToUse), {
                        config: state.config,
                        tasks: state.tasks,
                        lastUpdated: new Date().toISOString(),
                        authorId: state.user?.uid || 'anon'
                    });
                    
                    if (!state.chartId) {
                        state.chartId = idToUse;
                        const url = new URL(window.location.href);
                        url.searchParams.set('id', idToUse);
                        window.history.pushState({}, '', url);
                    }
                    
                    if(!silent) App.showToast("Saved!", "success");
                    
                    const d = new Date();
                    const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('save-status').innerText = `Saved ${dateStr}`;
                    document.getElementById('save-status').className = "text-[10px] text-gray-400 dark:text-slate-500 truncate max-w-[200px] whitespace-nowrap";
                    
                } catch(e) {
                    console.error(e);
                    if(!silent) App.showToast("Error saving", "error");
                }
            },

            shareLink: async () => {
                if(!state.chartId) await App.saveChart();
                const url = new URL(window.location.href);
                if(state.chartId) url.searchParams.set('id', state.chartId);
                
                navigator.clipboard.writeText(url.toString()).then(() => {
                    App.showToast("Link Copied!", "success");
                }).catch(() => {
                    prompt("Copy link:", url.toString());
                });
            },

            zoomIn: () => { state.zoom = Math.min(state.zoom + 4, 80); App.updateZoom(); },
            zoomOut: () => { state.zoom = Math.max(state.zoom - 4, 8); App.updateZoom(); },
            handleZoomSubmit: () => {
                const inp = document.getElementById('zoom-input');
                let val = parseInt(inp.value.replace('%', ''));
                if (isNaN(val)) val = 100;
                val = Math.max(20, Math.min(200, val));
                state.zoom = (val / 100) * 40;
                App.updateZoom();
            },
            updateZoom: () => {
                document.getElementById('zoom-input').value = Math.round((state.zoom / 40) * 100) + '%';
                App.renderChart();
            },
            
            toggleConfig: () => {
                state.showLegend = !state.showLegend;
                const wrapper = document.getElementById('drawer-wrapper');
                const panel = document.getElementById('drawer-panel');
                const chevron = document.getElementById('drawer-chevron');
                
                if (state.showLegend) {
                    panel.style.height = '40vh'; // Reduced height
                    wrapper.classList.add('is-open');
                    chevron.classList.add('rotate-180');
                    App.renderConfigPanel();
                } else {
                    panel.style.height = '0';
                    wrapper.classList.remove('is-open');
                    chevron.classList.remove('rotate-180');
                }
                lucide.createIcons();
            },
            
            addConfigItem: (type) => {
                if(type === 'pic') state.config.picMap.push({ abbr: 'NEW', name: 'New Member', color: '#000000' });
                if(type === 'status') state.config.statusMap.push({ name: 'New Status', color: '#000000' });
                App.renderConfigPanel();
                // Removed App.renderAll() as it was causing full UI reset
                App.autoSave();
            },
            
            removeConfigItem: (type, index) => {
                if(confirm('Delete this item?')) {
                    if(type === 'pic') state.config.picMap.splice(index, 1);
                    if(type === 'status') state.config.statusMap.splice(index, 1);
                    App.renderConfigPanel();
                    // Removed App.renderAll()
                    App.autoSave();
                }
            },

            updateConfig: (path, index, field, value) => {
                if (path === 'title') {
                    state.config.title = value;
                    document.getElementById('app-title').value = value;
                }
                if (path === 'picMap') {
                    state.config.picMap[index][field] = value;
                }
                if (path === 'statusMap') {
                    state.config.statusMap[index][field] = value;
                }
                
                if (field === 'color' || path === 'themeColor') {
                    if (path === 'themeColor') state.config.themeColor = value;
                    App.renderChart();
                    App.renderTable();
                    App.renderConfigPanel(); 
                    App.updateGlobalTheme(); // Ensure theme applies instantly
                }
                
                App.autoSave();
            },

            showToast: (msg, type) => {
                const t = document.getElementById('toast');
                t.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'}`;
                document.getElementById('toast-message').innerText = msg;
                document.getElementById('toast-icon').innerHTML = type === 'success' ? '<i data-lucide="check" class="w-3 h-3"></i>' : '';
                lucide.createIcons();
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
                t.classList.remove('translate-y-20', 'opacity-0');
            }
        };

        window.app = App;
        App.init();
    </script>
</body>
</html>
