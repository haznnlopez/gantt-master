<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GanttMaster Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#293548', 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color: #f472b6;
            --theme-light: #fbcfe8;
            --theme-dark: #db2777;
            --theme-bg-light: #fdf2f8; 
        }
        body { font-family: 'Inter', sans-serif; }
        .theme-text { color: var(--theme-color); }
        .theme-bg { background-color: var(--theme-color); }
        .theme-border { border-color: var(--theme-color); }
        .theme-shadow { box-shadow: 0 4px 6px -1px var(--theme-light), 0 2px 4px -1px rgba(0,0,0,0.06); }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen transition-colors duration-200">

    <nav class="border-b border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-6 py-4 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-pink-400 to-rose-400 p-2 rounded-lg text-white shadow-lg">
                    <i data-lucide="layout-grid" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-tight tracking-tight">GanttMaster</h1>
                    <p class="text-xs text-gray-400 font-medium uppercase tracking-widest">Dashboard</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                 <button onclick="app.toggleDarkMode()" class="p-2 text-gray-500 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
                </button>
                <a href="index.html" class="theme-bg text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-md hover:brightness-95 transition-all flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> New Project
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6">
        
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Your Projects</h2>
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Search projects..." class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:outline-none focus:ring-2 focus:ring-pink-300 w-64 transition-all">
            </div>
        </div>

        <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading State -->
            <div class="col-span-full py-20 flex flex-col items-center justify-center text-gray-400">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-4 theme-text"></i>
                <p>Loading your charts...</p>
            </div>
        </div>

        <div id="empty-state" class="hidden flex-col items-center justify-center py-20 text-center">
            <div class="bg-gray-100 dark:bg-slate-800 p-6 rounded-full mb-6">
                <i data-lucide="folder-open" class="w-12 h-12 text-gray-400"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200 mb-2">No projects yet</h3>
            <p class="text-gray-500 max-w-md mb-8">Create your first Gantt chart to get started planning your tasks.</p>
            <a href="index.html" class="theme-bg text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-transform">Create Project</a>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDocs, collection, query, orderBy, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        let firebaseConfig = {
            apiKey: "AIzaSyBaZJ49zEo4GoWR3LoyDba5J3wkPkaOfWs",
            authDomain: "gantt-master.firebaseapp.com",
            projectId: "gantt-master",
            storageBucket: "gantt-master.firebasestorage.app",
            messagingSenderId: "822947741694",
            appId: "1:822947741694:web:41f0828656259cc0200aaf",
            measurementId: "G-2KK6BNYHPP"
        };

        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gantt-master-public';
        let appInstance, authInstance, dbInstance;
        let projects = [];

        try {
            if (firebaseConfig.apiKey) {
                appInstance = initializeApp(firebaseConfig);
                authInstance = getAuth(appInstance);
                dbInstance = getFirestore(appInstance);
            }
        } catch(e) { console.error("Firebase Init Error:", e); }

        const App = {
            init: async () => {
                // Auth
                if (authInstance) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(authInstance, __initial_auth_token);
                    else await signInAnonymously(authInstance);
                    onAuthStateChanged(authInstance, (u) => { App.fetchProjects(); });
                }

                // Theme
                if (localStorage.getItem('gantt-theme') === 'dark' || (!('gantt-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('theme-icon').setAttribute('data-lucide', 'sun');
                }
                
                // Search
                document.getElementById('search-input').addEventListener('input', (e) => {
                    App.renderProjects(e.target.value);
                });
                
                lucide.createIcons();
            },

            toggleDarkMode: () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('gantt-theme', isDark ? 'dark' : 'light');
                document.getElementById('theme-icon').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
            },

            fetchProjects: async () => {
                if (!dbInstance) return;
                
                try {
                    const q = query(collection(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts')); // Simple query rule
                    const snapshot = await getDocs(q);
                    
                    projects = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })).sort((a,b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0)); // Sort in JS to avoid index requirement
                    
                    App.renderProjects();
                } catch (e) {
                    console.error("Error fetching:", e);
                    document.getElementById('projects-grid').innerHTML = `<div class="col-span-full text-center text-red-400">Error loading projects.</div>`;
                }
            },

            renderProjects: (filterText = '') => {
                const grid = document.getElementById('projects-grid');
                const empty = document.getElementById('empty-state');
                
                const filtered = projects.filter(p => {
                    const title = p.config?.title || 'Untitled';
                    const sub = p.config?.subtitle || '';
                    const term = filterText.toLowerCase();
                    return title.toLowerCase().includes(term) || sub.toLowerCase().includes(term);
                });

                if (projects.length === 0) {
                    grid.classList.add('hidden');
                    empty.classList.remove('hidden');
                    empty.classList.add('flex');
                    return;
                }

                grid.classList.remove('hidden');
                empty.classList.add('hidden');
                empty.classList.remove('flex');
                
                grid.innerHTML = '';
                
                if (filtered.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No matching projects found.</div>`;
                    return;
                }

                filtered.forEach(p => {
                    const title = p.config?.title || 'Untitled Project';
                    const subtitle = p.config?.subtitle || 'GANTTMASTER';
                    const theme = p.config?.themeColor || '#f472b6';
                    const date = p.lastUpdated ? new Date(p.lastUpdated).toLocaleDateString() : 'Unknown date';
                    const taskCount = p.tasks ? p.tasks.length : 0;
                    
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-slate-800 rounded-xl p-5 border border-gray-100 dark:border-slate-700 shadow-sm card-hover transition-all cursor-pointer group relative overflow-hidden";
                    card.onclick = (e) => {
                        if (!e.target.closest('.action-btn')) window.location.href = `index.html?id=${p.id}`;
                    };

                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-1.5 h-full" style="background-color: ${theme}"></div>
                        <div class="flex justify-between items-start mb-4 pl-3">
                            <div>
                                <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100 mb-1 group-hover:text-pink-500 transition-colors">${title}</h3>
                                <p class="text-xs text-gray-400 font-bold tracking-wider uppercase">${subtitle}</p>
                            </div>
                            <button onclick="app.deleteProject('${p.id}')" class="action-btn text-gray-300 hover:text-red-500 transition-colors p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20" title="Delete Project">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-slate-400 pl-3 mb-4">
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="calendar" class="w-3.5 h-3.5"></i>
                                <span>${date}</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="list-todo" class="w-3.5 h-3.5"></i>
                                <span>${taskCount} Activities</span>
                            </div>
                        </div>

                        <div class="flex justify-end pl-3 pt-2 border-t border-gray-50 dark:border-slate-700/50">
                            <span class="text-xs font-bold text-pink-500 group-hover:translate-x-1 transition-transform flex items-center gap-1">
                                Open Project <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                lucide.createIcons();
            },
            
            deleteProject: async (id) => {
                if(confirm('Are you sure you want to delete this project permanently?')) {
                    try {
                        await deleteDoc(doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', id));
                        // Remove locally
                        projects = projects.filter(p => p.id !== id);
                        App.renderProjects(document.getElementById('search-input').value);
                    } catch(e) {
                        console.error(e);
                        alert('Failed to delete');
                    }
                }
            }
        };

        window.app = App;
        App.init();
    </script>
</body>
</html>
