<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GanttMaster</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hide Date Picker Icon */
        input[type="date"]::-webkit-calendar-picker-indicator { display: none; -webkit-appearance: none; }
        
        /* Animation */
        @keyframes fade-in { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        
        /* Tooltip Arrow */
        .tooltip-arrow {
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%) translateY(100%);
            width: 0; 
            height: 0; 
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(17, 24, 39, 0.95);
        }
        
        /* Ensure rows align perfectly */
        .row-height { height: 52px; }
        .header-height { height: 50px; }
    </style>
</head>
<body class="bg-white text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="border-b border-gray-200 bg-white px-4 py-3 flex items-center justify-between sticky top-0 z-40 shadow-sm shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white shadow-blue-200 shadow-lg">
                <i data-lucide="align-left" class="w-5 h-5"></i>
            </div>
            <div>
                <input id="app-title" type="text" class="font-bold text-lg leading-tight tracking-tight outline-none bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded px-1 transition-colors w-full" value="Project Timeline 2024">
                <input id="app-subtitle" type="text" class="text-[10px] text-gray-400 uppercase tracking-widest font-medium outline-none bg-transparent hover:bg-gray-50 focus:bg-gray-50 rounded px-1 transition-colors w-full" value="GANTTMASTER">
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Zoom Controls -->
            <div class="hidden md:flex items-center bg-gray-100 rounded-lg p-1 mr-2">
                <button onclick="app.zoomOut()" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-white rounded transition-colors" title="Zoom Out"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                <input id="zoom-input" type="text" class="bg-transparent text-xs font-bold text-gray-600 outline-none mx-1 w-10 text-center focus:bg-white rounded" value="100%">
                <button onclick="app.zoomIn()" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-white rounded transition-colors" title="Zoom In"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
            </div>

            <div class="h-6 w-px bg-gray-200 mx-2 hidden md:block"></div>
            
            <button onclick="app.toggleSettings()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></button>
            <button onclick="app.saveChart()" class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Save</span></button>
            <button onclick="app.shareLink()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-md shadow-blue-200 transition-colors"><i data-lucide="share-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Share Link</span></button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- Table Pane -->
        <div id="table-pane" class="overflow-y-auto overflow-x-auto border-r border-gray-200 bg-white h-full custom-scrollbar flex-none z-10" style="width: 550px;">
            <table class="w-full text-sm text-left table-fixed min-w-[550px]">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200 sticky top-0 z-20 header-height">
                    <tr>
                        <th class="px-2 align-middle w-10">No.</th>
                        <th class="px-2 align-middle w-48">Activity</th>
                        <th class="px-2 align-middle w-24">Start</th>
                        <th class="px-2 align-middle w-24">End</th>
                        <th class="px-2 align-middle w-12 text-center">Days</th>
                        <th class="px-2 align-middle w-24">PIC</th>
                        <th class="px-2 align-middle w-24">Status</th>
                        <th class="px-2 align-middle w-8"></th>
                    </tr>
                </thead>
                <tbody id="task-table-body">
                    <!-- Rows generated by JS -->
                </tbody>
            </table>
        </div>

        <!-- Chart Pane -->
        <div id="chart-pane" class="flex-1 overflow-auto bg-gray-50/50 relative custom-scrollbar h-full cursor-grab">
            <div id="chart-content" class="relative">
                <!-- Header Dates -->
                <div id="chart-header" class="flex border-b border-gray-200 bg-gray-50 sticky top-0 z-10 header-height">
                    <!-- Dates generated by JS -->
                </div>
                <!-- Bars -->
                <div id="chart-bars" class="pt-0">
                    <!-- Bars generated by JS -->
                </div>
                <!-- Today Line -->
                <div id="today-line" class="absolute top-0 bottom-0 border-l-2 border-red-500/30 z-0 pointer-events-none hidden">
                    <div class="bg-red-500 text-white text-[9px] px-1 rounded absolute -top-1 -left-4 shadow-sm z-20">Today</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Legend Button -->
    <div class="fixed bottom-6 right-6 z-[60]">
        <button onclick="app.toggleLegend()" class="bg-gray-800 text-white px-4 py-3 rounded-full shadow-xl flex items-center gap-2 text-sm font-bold hover:bg-gray-900 transition-all hover:scale-105">
            <i data-lucide="users" class="w-4 h-4"></i>
            <span id="legend-chevron"><i data-lucide="chevron-up" class="w-4 h-4"></i></span>
        </button>
    </div>

    <!-- Legend Panel -->
    <div id="legend-panel" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transition-transform duration-300 z-50 translate-y-full">
        <div class="p-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-800">Chart Legends</h3>
                <button onclick="app.toggleLegend()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="legend-content" class="grid grid-cols-1 md:grid-cols-3 gap-8 pb-8">
                <!-- Legend items generated by JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i> Configuration</h3>
                <button onclick="app.toggleSettings()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="settings-content" class="p-6 max-h-[70vh] overflow-y-auto space-y-6 custom-scrollbar">
                <!-- Settings inputs generated by JS -->
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-end">
                <button onclick="app.toggleSettings()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">Done</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <!-- Custom Tooltip -->
    <div id="custom-tooltip" class="hidden fixed z-[100] bg-gray-900/95 backdrop-blur-sm text-white px-3 py-2 rounded-lg shadow-xl text-xs pointer-events-none mt-[-8px]">
        <div id="tooltip-title" class="font-bold mb-1 border-b border-gray-700 pb-1"></div>
        <div class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-0.5 text-[10px] text-gray-300">
            <span>Status:</span> <span id="tooltip-status" class="text-white"></span>
            <span>Date:</span> <span id="tooltip-date" class="text-white"></span>
        </div>
        <div class="tooltip-arrow"></div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // =================================================================================
        // CONFIGURATION: REPLACE THIS SECTION WITH YOUR FIREBASE KEYS FOR GITHUB HOSTING
        // =================================================================================
        
        let firebaseConfig = {
            apiKey: "AIzaSyBaZJ49zEo4GoWR3LoyDba5J3wkPkaOfWs",
            authDomain: "gantt-master.firebaseapp.com",
            projectId: "gantt-master",
            storageBucket: "gantt-master.firebasestorage.app",
            messagingSenderId: "822947741694",
            appId: "1:822947741694:web:41f0828656259cc0200aaf",
            measurementId: "G-2KK6BNYHPP"
        };

        // This block auto-fills keys ONLY when previewing in this chat environment.
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch(e) { console.log('Using default/manual config'); }
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gantt-master-app';
        // =================================================================================

        let appInstance, authInstance, dbInstance;
        
        try {
            // Only initialize if config is valid (simplistic check)
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
                appInstance = initializeApp(firebaseConfig);
                authInstance = getAuth(appInstance);
                dbInstance = getFirestore(appInstance);
            } else {
                console.warn("Firebase not configured. Saving/Sharing will be disabled.");
            }
        } catch(e) {
            console.error("Firebase Initialization Error:", e);
        }

        // --- State ---
        const state = {
            user: null,
            chartId: null,
            loading: true,
            zoom: 40,
            showLegend: false,
            activeDropdown: null,
            config: {
                title: "Project Timeline 2024",
                subtitle: "GanttMaster",
                picMap: [
                    { id: '1', abbr: 'TL', name: 'Team Lead', color: '#3b82f6' },
                    { id: '2', abbr: 'DEV', name: 'Developer', color: '#8b5cf6' },
                    { id: '3', abbr: 'DES', name: 'Designer', color: '#ec4899' },
                    { id: '4', abbr: 'QA', name: 'QA Engineer', color: '#f97316' },
                ],
                statusMap: [
                    { id: '1', name: 'Completed', color: '#22c55e' },
                    { id: '2', name: 'In Progress', color: '#eab308' },
                    { id: '3', name: 'Pending', color: '#94a3b8' },
                    { id: '4', name: 'Delayed', color: '#ef4444' },
                ],
                activityTypes: [
                    { id: '1', name: 'Major Activity', color: '#1e293b' },
                    { id: '2', name: 'Minor Activity', color: '#475569' },
                    { id: '3', name: 'Sub-Activity', color: '#94a3b8' },
                ]
            },
            tasks: [
                { id: '1', activityNo: '1.0', description: 'Project Kickoff', startDate: new Date().toISOString().split('T')[0], duration: 2, pics: ['TL'], status: 'Completed', type: 'Major Activity' },
                { id: '2', activityNo: '1.1', description: 'Requirements Gathering', startDate: addDays(new Date(), 2), duration: 5, pics: ['TL', 'DEV'], status: 'In Progress', type: 'Minor Activity' },
                { id: '3', activityNo: '2.0', description: 'Design System', startDate: addDays(new Date(), 5), duration: 7, pics: ['DES'], status: 'Pending', type: 'Major Activity' },
            ]
        };

        // --- Helpers ---
        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function formatDate(str) { 
            if(!str) return ''; 
            const d = new Date(str); 
            return d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }); 
        }
        function addDays(str, days) {
            const d = new Date(str);
            d.setDate(d.getDate() + parseInt(days));
            return d.toISOString().split('T')[0];
        }
        function getDaysDiff(start, end) {
            const s = new Date(start);
            const e = new Date(end);
            return Math.round((e - s) / (1000 * 60 * 60 * 24));
        }

        // --- Logic & Rendering ---

        const App = {
            init: async () => {
                // Auth
                if (authInstance) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(authInstance, __initial_auth_token);
                    } else {
                        await signInAnonymously(authInstance);
                    }
                    onAuthStateChanged(authInstance, (u) => {
                        state.user = u;
                        App.loadData();
                    });
                } else {
                    // Offline/Unconfigured mode
                    App.renderAll();
                }

                // Sync Scrolling
                const tablePane = document.getElementById('table-pane');
                const chartPane = document.getElementById('chart-pane');
                let isSyncingLeft = false;
                let isSyncingRight = false;

                tablePane.onscroll = function() {
                    if (!isSyncingLeft) {
                        isSyncingRight = true;
                        chartPane.scrollTop = this.scrollTop;
                    }
                    isSyncingLeft = false;
                };

                chartPane.onscroll = function() {
                    if (!isSyncingRight) {
                        isSyncingLeft = true;
                        tablePane.scrollTop = this.scrollTop;
                    }
                    isSyncingRight = false;
                };

                // Title Inputs
                document.getElementById('app-title').onchange = (e) => { state.config.title = e.target.value; };
                document.getElementById('app-subtitle').onchange = (e) => { state.config.subtitle = e.target.value; };
                
                // Zoom Input
                const zoomInp = document.getElementById('zoom-input');
                zoomInp.onblur = App.handleZoomSubmit;
                zoomInp.onkeydown = (e) => { if(e.key === 'Enter') App.handleZoomSubmit(); };
                
                // Global Click to close dropdowns
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('.pic-dropdown-container')) {
                        state.activeDropdown = null;
                        App.renderTable(); // Re-render to close dropdown
                    }
                });

                App.renderAll();
            },

            loadData: () => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id && dbInstance && state.user) {
                    state.chartId = id;
                    const docRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', id);
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            // Migration logic
                            const migratedTasks = data.tasks.map(t => ({
                                ...t,
                                pics: Array.isArray(t.pics) ? t.pics : (t.pic ? [t.pic] : [])
                            }));
                            state.config = { ...DEFAULT_CONFIG, ...data.config };
                            state.tasks = migratedTasks;
                            
                            // Update Title Inputs
                            document.getElementById('app-title').value = state.config.title;
                            document.getElementById('app-subtitle').value = state.config.subtitle;
                            
                            App.renderAll();
                        } else {
                            App.showToast("Chart not found. Created new.", "error");
                        }
                    });
                }
            },

            renderAll: () => {
                App.renderTable();
                App.renderChart();
                App.renderLegend();
                App.renderSettings();
                lucide.createIcons();
            },

            // --- Table Rendering ---
            renderTable: () => {
                const tbody = document.getElementById('task-table-body');
                tbody.innerHTML = '';

                state.tasks.forEach(task => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-100 hover:bg-gray-50 group transition-colors row-height";
                    
                    // Cells
                    tr.innerHTML = `
                        <td class="px-2 align-middle"><input type="text" class="w-full bg-transparent outline-none font-medium text-gray-600 focus:text-blue-600 text-xs" value="${task.activityNo}" onchange="app.updateTask('${task.id}', 'activityNo', this.value)"></td>
                        <td class="px-2 align-middle">
                            <div class="flex flex-col justify-center">
                                <input type="text" class="w-full bg-transparent outline-none font-medium text-gray-800 focus:border-b focus:border-blue-500 truncate" value="${task.description}" onchange="app.updateTask('${task.id}', 'description', this.value)">
                                <select class="text-[10px] text-gray-400 bg-transparent outline-none cursor-pointer mt-0.5" onchange="app.updateTask('${task.id}', 'type', this.value)">
                                    ${state.config.activityTypes.map(t => `<option value="${t.name}" ${task.type === t.name ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                        </td>
                        <td class="px-2 align-middle"><input type="date" class="bg-transparent outline-none text-gray-600 w-full cursor-pointer text-xs" value="${task.startDate}" onchange="app.updateTask('${task.id}', 'startDate', this.value)"></td>
                        <td class="px-2 align-middle"><input type="date" class="bg-transparent outline-none text-gray-600 w-full cursor-pointer text-xs" value="${addDays(task.startDate, task.duration - 1)}" onchange="app.updateTask('${task.id}', 'endDate', this.value)"></td>
                        <td class="px-2 align-middle text-center"><input type="number" min="1" class="w-full bg-transparent outline-none text-center text-xs" value="${task.duration}" onchange="app.updateTask('${task.id}', 'duration', this.value)"></td>
                        <td class="px-2 align-middle pic-cell"></td>
                        <td class="px-2 align-middle">
                             <select class="bg-transparent outline-none w-full text-xs px-1 py-1 rounded border border-transparent focus:border-gray-300 cursor-pointer" onchange="app.updateTask('${task.id}', 'status', this.value)">
                                ${state.config.statusMap.map(s => `<option value="${s.name}" ${task.status === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                             </select>
                        </td>
                        <td class="px-2 align-middle text-right">
                             <button onclick="app.removeTask('${task.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </td>
                    `;
                    
                    // Inject Custom Multi-Select logic
                    const picCell = tr.querySelector('.pic-cell');
                    picCell.appendChild(App.createPicDropdown(task));

                    tbody.appendChild(tr);
                });

                // Add Task Row
                const addRow = document.createElement('tr');
                addRow.className = "row-height";
                addRow.innerHTML = `<td colspan="8" class="px-2 py-2 align-middle"><button onclick="app.addTask()" class="flex items-center gap-2 text-blue-600 text-sm font-medium hover:bg-blue-50 px-3 py-2 rounded-lg w-full transition-colors"><i data-lucide="plus" class="w-4 h-4"></i> Add Activity</button></td>`;
                tbody.appendChild(addRow);
            },

            createPicDropdown: (task) => {
                const container = document.createElement('div');
                container.className = "relative pic-dropdown-container";
                
                const trigger = document.createElement('div');
                trigger.className = "flex flex-wrap gap-1 cursor-pointer min-h-[24px] items-center";
                trigger.onclick = (e) => {
                    e.stopPropagation();
                    state.activeDropdown = state.activeDropdown === task.id ? null : task.id;
                    App.renderTable(); // Re-render to toggle
                    lucide.createIcons();
                };

                if (!task.pics || task.pics.length === 0) {
                    trigger.innerHTML = `<span class="text-gray-300 italic text-[10px]">Select</span>`;
                } else {
                    task.pics.forEach(abbr => {
                        const conf = state.config.picMap.find(p => p.abbr === abbr) || { color: '#000' };
                        const tag = document.createElement('span');
                        tag.className = "text-[10px] font-bold px-1 rounded";
                        tag.style.color = conf.color;
                        tag.style.backgroundColor = `${conf.color}20`;
                        tag.innerText = abbr;
                        trigger.appendChild(tag);
                    });
                }
                container.appendChild(trigger);

                if (state.activeDropdown === task.id) {
                    const menu = document.createElement('div');
                    menu.className = "absolute top-full left-0 mt-1 bg-white border border-gray-200 shadow-xl rounded-lg p-2 z-50 w-48 animate-fade-in";
                    menu.onclick = (e) => e.stopPropagation(); // Prevent closing when clicking inside
                    
                    menu.innerHTML = `<div class="text-[10px] text-gray-400 font-bold mb-2 uppercase tracking-wider">Assign People</div>`;
                    
                    state.config.picMap.forEach(p => {
                        const isSelected = task.pics?.includes(p.abbr);
                        const item = document.createElement('div');
                        item.className = `flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-xs ${isSelected ? 'bg-blue-50' : 'hover:bg-gray-50'}`;
                        item.onclick = () => App.togglePic(task.id, p.abbr);
                        item.innerHTML = `
                            <div class="w-3 h-3 border rounded-sm flex items-center justify-center ${isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-300'}">
                                ${isSelected ? '<i data-lucide="check" class="w-2 h-2 text-white"></i>' : ''}
                            </div>
                            <div class="flex-1 flex items-center gap-2">
                                <span class="font-bold" style="color: ${p.color}">${p.abbr}</span>
                                <span class="text-gray-600 truncate">${p.name}</span>
                            </div>
                        `;
                        menu.appendChild(item);
                    });
                    container.appendChild(menu);
                }

                return container;
            },

            // --- Chart Rendering ---
            renderChart: () => {
                const header = document.getElementById('chart-header');
                const bars = document.getElementById('chart-bars');
                const todayLine = document.getElementById('today-line');
                
                header.innerHTML = '';
                bars.innerHTML = '';
                
                // Calculations
                let minDate = new Date();
                let maxDate = new Date();
                
                if (state.tasks.length > 0) {
                    const starts = state.tasks.map(t => new Date(t.startDate));
                    const ends = state.tasks.map(t => new Date(addDays(t.startDate, t.duration + 5)));
                    minDate = new Date(Math.min(...starts));
                    maxDate = new Date(Math.max(...ends));
                }
                minDate.setDate(minDate.getDate() - 2);

                const timelineDays = [];
                let curr = new Date(minDate);
                while(curr <= maxDate) {
                    timelineDays.push(new Date(curr));
                    curr.setDate(curr.getDate() + 1);
                }

                const totalWidth = timelineDays.length * state.zoom;
                document.getElementById('chart-content').style.width = `${totalWidth}px`;

                // Render Header
                timelineDays.forEach(date => {
                    const div = document.createElement('div');
                    div.className = "flex-shrink-0 border-r border-gray-200/50 flex flex-col items-center justify-center text-[10px] text-gray-500 select-none";
                    div.style.width = `${state.zoom}px`;
                    div.innerHTML = `<span class="font-bold">${date.getDate()}</span><span>${date.toLocaleDateString('en-US', { weekday: 'narrow' })}</span>`;
                    header.appendChild(div);
                });

                // Render Bars
                const startDateRef = timelineDays[0];
                state.tasks.forEach(task => {
                    const startOffset = getDaysDiff(startDateRef, task.startDate);
                    const typeConfig = state.config.activityTypes.find(t => t.name === task.type) || { color: '#ccc' };
                    const isCompleted = task.status === 'Completed';
                    const barColor = typeConfig.color;

                    const row = document.createElement('div');
                    row.className = "relative row-height w-full border-b border-dashed border-gray-100 flex items-center group hover:bg-white/50";
                    
                    const bar = document.createElement('div');
                    bar.className = `absolute h-6 rounded-sm text-xs flex items-center px-2 truncate transition-all duration-300 cursor-pointer hover:brightness-110 ${isCompleted ? 'shadow-sm' : ''}`;
                    
                    // Styles
                    bar.style.left = `${startOffset * state.zoom}px`;
                    bar.style.width = `${task.duration * state.zoom}px`;
                    bar.style.backgroundColor = isCompleted ? barColor : `${barColor}15`;
                    bar.style.border = isCompleted ? 'none' : `2px dashed ${barColor}`;
                    bar.style.color = isCompleted ? 'white' : barColor;

                    // Tooltip Events
                    bar.onmouseenter = (e) => App.showTooltip(e, task);
                    bar.onmouseleave = () => App.hideTooltip();

                    row.appendChild(bar);
                    bars.appendChild(row);
                });

                // Add empty buffer row for the "Add Activity" button alignment
                const buffer = document.createElement('div');
                buffer.className = "row-height border-b border-transparent";
                bars.appendChild(buffer);

                // Today Line
                const today = new Date();
                const offset = getDaysDiff(startDateRef, today);
                if (offset >= 0 && offset < timelineDays.length) {
                    todayLine.style.display = 'block';
                    todayLine.style.left = `${(offset * state.zoom) + (state.zoom/2)}px`;
                } else {
                    todayLine.style.display = 'none';
                }
            },

            // --- Legend Rendering ---
            renderLegend: () => {
                const container = document.getElementById('legend-content');
                container.innerHTML = '';
                
                // Activity Types
                const c1 = document.createElement('div');
                c1.innerHTML = `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Activity Types</h4>`;
                state.config.activityTypes.forEach(t => {
                    c1.innerHTML += `<div class="flex items-center gap-2 mb-2"><div class="w-3 h-3 rounded-sm" style="background:${t.color}"></div><span class="text-sm text-gray-600">${t.name}</span></div>`;
                });
                container.appendChild(c1);

                // Status
                const c2 = document.createElement('div');
                c2.innerHTML = `
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Status Styles</h4>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3"><div class="w-16 h-4 rounded-full bg-gray-400 flex items-center justify-center text-[8px] text-white">Solid</div><span class="text-sm text-gray-600">Completed</span></div>
                        <div class="flex items-center gap-3"><div class="w-16 h-4 rounded-full bg-gray-100 border-2 border-dashed border-gray-400 flex items-center justify-center text-[8px] text-gray-700">Dashed</div><span class="text-sm text-gray-600">Ongoing</span></div>
                    </div>`;
                container.appendChild(c2);

                // PICs
                const c3 = document.createElement('div');
                c3.innerHTML = `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Person In Charge</h4><div class="grid grid-cols-2 gap-2"></div>`;
                const grid = c3.querySelector('.grid');
                state.config.picMap.forEach(p => {
                    grid.innerHTML += `<div class="flex items-center gap-2"><span class="text-xs font-bold px-1.5 py-0.5 rounded" style="background:${p.color}20; color:${p.color}">${p.abbr}</span><span class="text-sm text-gray-600">${p.name}</span></div>`;
                });
                container.appendChild(c3);
            },

            renderSettings: () => {
                const c = document.getElementById('settings-content');
                // Could render settings inputs here... for brevity, skipped, but structure is ready.
            },

            // --- User Actions ---
            updateTask: (id, field, value) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task) return;
                
                if (field === 'duration') value = parseInt(value) || 1;
                if (field === 'endDate') {
                    const diff = getDaysDiff(task.startDate, value);
                    task.duration = diff >= 0 ? diff + 1 : 1;
                    // No need to set endDate directly
                } else {
                    task[field] = value;
                }
                
                App.renderAll();
            },

            togglePic: (id, abbr) => {
                const task = state.tasks.find(t => t.id === id);
                if (!task.pics) task.pics = [];
                if (task.pics.includes(abbr)) task.pics = task.pics.filter(p => p !== abbr);
                else task.pics.push(abbr);
                App.renderTable(); // Only table needed
                lucide.createIcons();
            },

            addTask: () => {
                const last = state.tasks[state.tasks.length-1];
                const start = last ? last.startDate : new Date().toISOString().split('T')[0];
                state.tasks.push({
                    id: generateId(),
                    activityNo: (state.tasks.length + 1).toFixed(1),
                    description: 'New Activity',
                    startDate: start,
                    duration: 1,
                    pics: ['TL'],
                    status: 'Pending',
                    type: 'Major Activity'
                });
                App.renderAll();
            },

            removeTask: (id) => {
                state.tasks = state.tasks.filter(t => t.id !== id);
                App.renderAll();
            },

            // --- Zoom ---
            zoomIn: () => {
                state.zoom = Math.min(state.zoom + 4, 80);
                App.updateZoomDisplay();
            },
            zoomOut: () => {
                state.zoom = Math.max(state.zoom - 4, 8);
                App.updateZoomDisplay();
            },
            handleZoomSubmit: () => {
                const inp = document.getElementById('zoom-input');
                let val = parseInt(inp.value.replace('%', ''));
                if (isNaN(val)) val = 100;
                val = Math.max(20, Math.min(200, val));
                state.zoom = (val / 100) * 40;
                App.updateZoomDisplay();
            },
            updateZoomDisplay: () => {
                document.getElementById('zoom-input').value = Math.round((state.zoom / 40) * 100) + '%';
                App.renderChart();
            },

            // --- UI Toggles ---
            toggleLegend: () => {
                state.showLegend = !state.showLegend;
                const panel = document.getElementById('legend-panel');
                const chevron = document.getElementById('legend-chevron');
                
                if(state.showLegend) {
                    panel.classList.remove('translate-y-full');
                    panel.classList.add('translate-y-0');
                    chevron.innerHTML = `<i data-lucide="chevron-down" class="w-4 h-4"></i>`;
                } else {
                    panel.classList.add('translate-y-full');
                    panel.classList.remove('translate-y-0');
                    chevron.innerHTML = `<i data-lucide="chevron-up" class="w-4 h-4"></i>`;
                }
                lucide.createIcons();
            },

            toggleSettings: () => {
                const modal = document.getElementById('settings-modal');
                if (modal.classList.contains('hidden')) modal.classList.remove('hidden');
                else modal.classList.add('hidden');
            },

            // --- Tooltip ---
            showTooltip: (e, task) => {
                const tip = document.getElementById('custom-tooltip');
                const rect = e.target.getBoundingClientRect();
                
                document.getElementById('tooltip-title').innerText = `${task.activityNo} ${task.description}`;
                document.getElementById('tooltip-status').innerText = task.status;
                const end = addDays(task.startDate, task.duration - 1);
                document.getElementById('tooltip-date').innerText = `${formatDate(task.startDate)} - ${formatDate(end)}`;
                
                tip.style.left = `${rect.left + (rect.width/2)}px`;
                tip.style.top = `${rect.top}px`;
                tip.classList.remove('hidden');
            },

            hideTooltip: () => {
                document.getElementById('custom-tooltip').classList.add('hidden');
            },

            // --- Saving ---
            saveChart: async () => {
                if(!dbInstance) {
                    App.showToast("No Database Configured", "error");
                    return;
                }
                App.showToast("Saving...", "info");
                const idToUse = state.chartId || generateId();
                try {
                    await setDoc(doc(dbInstance, 'artifacts', appId, 'public', 'data', 'gantt_charts', idToUse), {
                        config: state.config,
                        tasks: state.tasks,
                        lastUpdated: new Date().toISOString(),
                        authorId: state.user?.uid || 'anon'
                    });
                    
                    if (!state.chartId) {
                        state.chartId = idToUse;
                        const url = new URL(window.location.href);
                        url.searchParams.set('id', idToUse);
                        window.history.pushState({}, '', url);
                    }
                    App.showToast("Chart Saved Successfully!", "success");
                } catch(e) {
                    console.error(e);
                    App.showToast("Failed to save.", "error");
                }
            },

            shareLink: async () => {
                if(!state.chartId) await App.saveChart();
                if(state.chartId) {
                    navigator.clipboard.writeText(window.location.href);
                    App.showToast("Link Copied to Clipboard!", "success");
                }
            },

            showToast: (msg, type) => {
                const t = document.getElementById('toast');
                const icon = document.getElementById('toast-icon');
                const txt = document.getElementById('toast-message');
                
                t.className = `fixed bottom-8 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 z-[70] transition-all duration-300 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'}`;
                icon.innerHTML = type === 'success' ? '<i data-lucide="check" class="w-3 h-3"></i>' : '';
                txt.innerText = msg;
                
                lucide.createIcons();
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
                t.classList.remove('translate-y-20', 'opacity-0');
            }
        };

        // Expose to window for inline onclicks
        window.app = App;

        // Start
        App.init();
    </script>
</body>
</html>